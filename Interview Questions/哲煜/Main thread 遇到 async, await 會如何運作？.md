#### ðŸ“… **Date**: 2025-03-13

#### ðŸ”– **Tags**: #Basic #InterviewQuestions

---

ç•¶ **ä¸»åŸ·è¡Œç·’ï¼ˆMain Threadï¼‰** åŸ·è¡Œ **`async` æ–¹æ³•** ä¸¦é‡åˆ° **`await`**ï¼Œæœƒ**ç™¼ç”Ÿä»€éº¼ï¼Ÿå®ƒæœƒå¡ä½å—Žï¼Ÿé‚„æ˜¯ç¹¼çºŒåŸ·è¡Œå…¶ä»–ä»»å‹™ï¼Ÿ**

é€™æ˜¯ C# å’Œ .NET é¢è©¦çš„ç¶“å…¸å•é¡Œï¼Œè€ƒå¯Ÿä½ å° **éžåŒæ­¥ï¼ˆAsynchronousï¼‰** å’Œ **äº‹ä»¶é©…å‹•æž¶æ§‹ï¼ˆEvent Loopï¼‰** çš„ç†è§£ã€‚

---

## **ðŸ“ 1. `async` / `await` çš„åŸºæœ¬æ¦‚å¿µ**

- **`async`**ï¼šè¡¨ç¤ºè©²æ–¹æ³•æ˜¯ã€ŒéžåŒæ­¥ã€çš„ï¼Œå¯èƒ½æœƒåŸ·è¡Œ `await` æ“ä½œã€‚
- **`await`**ï¼šç•¶é‡åˆ° `await` æ™‚ï¼Œç¨‹å¼æœƒã€Œæš«æ™‚è®“å‡ºä¸»åŸ·è¡Œç·’ã€ï¼Œä½†ä¸æœƒé˜»å¡žä¸»åŸ·è¡Œç·’ã€‚

```csharp
async Task DoWork() {
	Console.WriteLine("é–‹å§‹å·¥ä½œ");
	await Task.Delay(2000); // æ¨¡æ“¬è€—æ™‚æ“ä½œ
	Console.WriteLine("å·¥ä½œå®Œæˆ");
}
```

**æµç¨‹ï¼š** 
1. **DoWork() é–‹å§‹åŸ·è¡Œ**ï¼Œè¼¸å‡º `"é–‹å§‹å·¥ä½œ"`ã€‚  
2. **é‡åˆ° `await Task.Delay(2000)`**ï¼š

- **ä¸»åŸ·è¡Œç·’ï¼ˆMain Threadï¼‰è®“å‡ºæŽ§åˆ¶æ¬Š**ï¼ŒåŸ·è¡Œå…¶ä»–å·¥ä½œ
- `Task.Delay(2000)` åœ¨ **èƒŒæ™¯åŸ·è¡Œç·’** éžåŒæ­¥ç­‰å¾… **2 ç§’å¾Œï¼ŒèƒŒæ™¯å·¥ä½œå®Œæˆ**ï¼Œå›žåˆ° **ä¸»åŸ·è¡Œç·’**ï¼ŒåŸ·è¡Œ `"å·¥ä½œå®Œæˆ"`ã€‚

---

## **ðŸ“ 2. `Main Thread` æœƒè¢« `await` é˜»å¡žå—Žï¼Ÿ**

è®“æˆ‘å€‘æ¸¬è©¦ä»¥ä¸‹ `Main()` æ–¹æ³•ï¼š

```csharp
static async Task Main() {
	Console.WriteLine("é–‹å§‹");
	await DoWork();
	Console.WriteLine("çµæŸ");
}
```

### **ðŸ“Œ åŸ·è¡Œçµæžœ**

```shell
é–‹å§‹
é–‹å§‹å·¥ä½œ
ï¼ˆ2 ç§’å¾Œï¼‰
å·¥ä½œå®Œæˆ
çµæŸ
```

### **ðŸ“Œ ç™¼ç”Ÿäº†ä»€éº¼ï¼Ÿ**

- **`Main Thread` åŸ·è¡Œ `"é–‹å§‹"`**
- **`DoWork()` åŸ·è¡Œ `"é–‹å§‹å·¥ä½œ"`**
- **é‡åˆ° `await Task.Delay(2000)`ï¼Œ`Main Thread` è®“å‡º CPU**
- **2 ç§’å¾Œï¼ŒèƒŒæ™¯åŸ·è¡Œç·’å®Œæˆï¼Œç¹¼çºŒåŸ·è¡Œ `"å·¥ä½œå®Œæˆ"`**
- **åŸ·è¡Œ `"çµæŸ"`**

ðŸ‘‰ **é‡é»ž**ï¼š`Main Thread` **ä¸æœƒè¢«é˜»å¡žï¼Œè€Œæ˜¯æœƒåŽ»åŸ·è¡Œå…¶ä»–å·¥ä½œï¼**

---

## **ðŸ“ 3. `await` èˆ‡ `ConfigureAwait(false)` çš„å½±éŸ¿**

### **ðŸ”¹ é è¨­æƒ…æ³**

`await` ä¹‹å¾Œçš„ç¨‹å¼ç¢¼æœƒ**å›žåˆ°åŽŸæœ¬çš„åŸ·è¡Œç·’ï¼ˆSynchronization Contextï¼‰**ï¼š

```csharp
async Task DoWork() {
	Console.WriteLine($"é–‹å§‹å·¥ä½œï¼šåŸ·è¡Œç·’ {Thread.CurrentThread.ManagedThreadId}");
	await Task.Delay(2000);
	Console.WriteLine($"å·¥ä½œå®Œæˆï¼šåŸ·è¡Œç·’ {Thread.CurrentThread.ManagedThreadId}");
}
```

**å¯èƒ½çš„è¼¸å‡ºï¼š**

```shell
é–‹å§‹å·¥ä½œï¼šåŸ·è¡Œç·’ 1
ï¼ˆ2 ç§’å¾Œï¼‰
å·¥ä½œå®Œæˆï¼šåŸ·è¡Œç·’ 1
```

ðŸ‘‰ **çµæžœ**ï¼šåŸ·è¡Œç·’ `1`ï¼ˆä¸»åŸ·è¡Œç·’ï¼‰è² è²¬åŸ·è¡Œ `"é–‹å§‹å·¥ä½œ"` å’Œ `"å·¥ä½œå®Œæˆ"`ã€‚

---

### **ðŸ”¹ `ConfigureAwait(false)`**

ä½¿ç”¨ `ConfigureAwait(false)` **é¿å…å›žåˆ°ä¸»åŸ·è¡Œç·’**ï¼Œå¯ä»¥æå‡æ•ˆèƒ½ï¼š

```csharp
async Task DoWork() {
	Console.WriteLine($"é–‹å§‹å·¥ä½œï¼šåŸ·è¡Œç·’ {Thread.CurrentThread.ManagedThreadId}");
	await Task.Delay(2000).ConfigureAwait(false);
	Console.WriteLine($"å·¥ä½œå®Œæˆï¼šåŸ·è¡Œç·’ {Thread.CurrentThread.ManagedThreadId}");
}
```

**å¯èƒ½çš„è¼¸å‡ºï¼š**

```shell
é–‹å§‹å·¥ä½œï¼šåŸ·è¡Œç·’ 1
ï¼ˆ2 ç§’å¾Œï¼‰
å·¥ä½œå®Œæˆï¼šåŸ·è¡Œç·’ 5
```

ðŸ‘‰ **çµæžœ**ï¼š`å·¥ä½œå®Œæˆ` åœ¨èƒŒæ™¯åŸ·è¡Œç·’ï¼ˆå¦‚ `5`ï¼‰åŸ·è¡Œï¼Œè€Œä¸å›žåˆ°ä¸»åŸ·è¡Œç·’ã€‚

---

## **ðŸ“ 4. `Main Thread` vs `UI Thread`**

å¦‚æžœæ˜¯ **`Console App`**ï¼Œ`Main Thread` **ä¸ä¸€å®šæ˜¯ UI åŸ·è¡Œç·’**ï¼Œè€Œ `await` ä¹‹å¾Œçš„ç¨‹å¼ç¢¼å¯èƒ½æœƒåœ¨èƒŒæ™¯åŸ·è¡Œç·’åŸ·è¡Œã€‚

ä½†å¦‚æžœæ˜¯ **`WinForms` / `WPF` æ‡‰ç”¨ç¨‹å¼**ï¼Œ`Main Thread` **å°±æ˜¯ UI åŸ·è¡Œç·’**ï¼š

- **æ²’æœ‰ `ConfigureAwait(false)`**ï¼šæœƒå›žåˆ° UI åŸ·è¡Œç·’ï¼Œç¢ºä¿ UI å¯æ“ä½œã€‚
- **åŠ ä¸Š `ConfigureAwait(false)`**ï¼šå¯èƒ½åœ¨èƒŒæ™¯åŸ·è¡Œç·’åŸ·è¡Œï¼Œé¿å…å½±éŸ¿ UI æ•ˆèƒ½ã€‚

---

## **ðŸ“ 5. é¢è©¦å»¶ä¼¸å•é¡Œ**

### **Q1: `async void` å’Œ `async Task` æœ‰ä»€éº¼å€åˆ¥ï¼Ÿ**

| |`async void`|`async Task`|
|---|---|---|
|**å›žå‚³å€¼**|ç„¡å›žå‚³å€¼|å›žå‚³ `Task`|
|**ä¾‹å¤–è™•ç†**|**ç„¡æ³• `try-catch` æ•æ‰ç•°å¸¸**|å¯ç”¨ `await` æ­£ç¢ºæ•æ‰ç•°å¸¸|
|**é©ç”¨å ´æ™¯**|**äº‹ä»¶è™•ç†ï¼ˆå¦‚ Button Clickï¼‰**|ä¸€èˆ¬ `async` æ–¹æ³•|

**ä¾‹å­ï¼š**

```csharp
async void Button_Click(object sender, EventArgs e) {  // åªèƒ½ç”¨æ–¼äº‹ä»¶
	await DoWork();
}
```

```csharp
async Task SomeMethodAsync() {  // å¯ç”¨ await
	await DoWork();
}
```

---

### **Q2: `Task.Run()` vs `async/await` æœ‰ä»€éº¼ä¸åŒï¼Ÿ**

| |`Task.Run()`|`async/await`|
|---|---|---|
|**ä½¿ç”¨å ´æ™¯**|**CPU å¯†é›†åž‹** å·¥ä½œ|**I/O å¯†é›†åž‹**ï¼ˆå¦‚ API å‘¼å«ï¼‰|
|**åŸ·è¡Œç·’**|**é–‹æ–°åŸ·è¡Œç·’** åŸ·è¡Œ|åªè¦ `await`ï¼Œä¸»åŸ·è¡Œç·’å¯ç¹¼çºŒåŸ·è¡Œ|

**ç¯„ä¾‹ï¼š**

```csharp
// ä½¿ç”¨ Task.Run() åŸ·è¡Œ CPU å¯†é›†åž‹å·¥ä½œ
Task.Run(() => {
	for (int i = 0; i < 1000000; i++) {
		Math.Sqrt(i);
	}
});
```

```csharp
// ä½¿ç”¨ async/await åŸ·è¡Œ I/O æ“ä½œ
await HttpClient.GetStringAsync("https://example.com");
```

---

### **Q3: `await Task.Delay(0)` æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ**

```csharp
await Task.Delay(0);
```

- `Task.Delay(0)` **ä¸æœƒçœŸæ­£ç­‰å¾…**ï¼Œä½†**æœƒè®“å‡ºä¸»åŸ·è¡Œç·’**ï¼Œé¡žä¼¼ `Thread.Yield()`ã€‚
- å¯èƒ½çš„ç”¨é€”ï¼šè®“ç›®å‰çš„ `Thread` äº¤å‡º CPU çµ¦å…¶ä»–ç­‰å¾…ä¸­çš„ `Task`ã€‚

---

## **ðŸ“Œ ç¸½çµ**

1. **`async` æ–¹æ³•** ç¢°åˆ° **`await`**ï¼Œæœƒè®“å‡º `Main Thread` åŸ·è¡Œå…¶ä»–å·¥ä½œï¼Œè€Œéžé˜»å¡žä¸»åŸ·è¡Œç·’ã€‚  
2. **`ConfigureAwait(false)`** å¯é¿å…å›žåˆ° `Main Thread`ï¼Œæå‡æ•ˆèƒ½ï¼ˆé©ç”¨æ–¼ `Console` å’Œ `ASP.NET`ï¼‰ã€‚  
3. **`async void` åªèƒ½ç”¨æ–¼äº‹ä»¶è™•ç†**ï¼Œå…¶ä»–æƒ…å¢ƒæ‡‰è©²ç”¨ `async Task`ã€‚  
4. **`Task.Run()` ç”¨æ–¼ CPU å¯†é›†åž‹å·¥ä½œ**ï¼Œ`async/await` é©ç”¨æ–¼ I/O æ“ä½œã€‚

---

ðŸ”¥ **é¢è©¦æŠ€å·§**ï¼šç•¶é¢è©¦å®˜å• **ã€Œ`await` æœƒä¸æœƒé˜»å¡ž `Main Thread`ï¼Ÿã€**  
âœ… **æ­£ç¢ºå›žç­”**ï¼š  
**ã€Œä¸æœƒï¼Œ`await` æœƒè®“å‡º `Main Thread` çµ¦å…¶ä»–ä»»å‹™ï¼Œç•¶ `Task` å®Œæˆå¾Œå†å›žåˆ° `Main Thread` ç¹¼çºŒåŸ·è¡Œã€‚ã€**
# Pre-Operation 插件實作詳解

Pre-Operation 插件會在資料庫交易完成前執行，可直接修改傳入的資料。讓我詳細說明如何實作一個理想的 Pre-Operation 插件來同步 Incident Type 欄位：

## 推薦的 Pre-Operation 插件寫法

```csharp
using System;
using Microsoft.Xrm.Sdk;
using Twtoto.ASManagement.Core;

namespace Twtoto.ASManagement.IncidentPlugins
{
    public class IncidentTypeSync : PluginHandler, IPlugin
    {
        protected override string PluginName => "IncidentTypeSync";
        protected override string[] RequiredInputParameters => new string[] { "Target" };
        public override LogLevel CurrentLogLevel => LogLevel.Debug;

        public void Execute(IServiceProvider serviceProvider)
        {
            Run(serviceProvider);
        }

        protected override void ExecuteCore()
        {
            Log(LogLevel.Debug, "進入 IncidentTypeSync ExecuteCore 方法 (Pre-Operation)。");

            // 1. 檢查是否為 Update 訊息
            if (_context.MessageName.ToLower() != "update")
            {
                Log(LogLevel.Debug, $"非 Update 訊息 ({_context.MessageName})，插件結束。");
                return;
            }

            // 2. 驗證實體類型
            if (_context.PrimaryEntityName.ToLower() != "incident")
            {
                Log(LogLevel.Debug, $"非 Incident 實體 ({_context.PrimaryEntityName})，插件結束。");
                return;
            }

            // 3. 取得 Target Entity
            Entity target = null;
            if (_context.InputParameters.Contains("Target") && _context.InputParameters["Target"] is Entity)
            {
                target = (Entity)_context.InputParameters["Target"];
                Log(LogLevel.Debug, "成功取得 Target Entity。");
            }
            else
            {
                Log(LogLevel.Error, "無法取得 Target Entity 或 Target 非 Entity 型別。");
                throw new InvalidPluginExecutionException("無法取得有效的 Target Entity。");
            }

            // 4. 防止插件無限循環執行
            if (_context.Depth > 1)
            {
                Log(LogLevel.Warning, $"插件執行深度已達 {_context.Depth}，為避免無限迴圈，提前結束。");
                return;
            }

            // 5. 檢查觸發更新的欄位是否包含我們關心的 'twtoto_incidenttype1'
            if (target.Contains("twtoto_incidenttype1"))
            {
                Log(LogLevel.Info, "偵測到 twtoto_incidenttype1 欄位變更，開始同步處理...");

                try
                {
                    // 6. 從 Target 取得 'twtoto_incidenttype1' 的值
                    EntityReference sourceIncidentTypeRef = target.GetAttributeValue<EntityReference>("twtoto_incidenttype1");

                    // 記錄欄位值
                    if (sourceIncidentTypeRef != null)
                    {
                        Log(LogLevel.Debug, $"來源欄位值: Id={sourceIncidentTypeRef.Id}, Name={sourceIncidentTypeRef.Name}, LogicalName={sourceIncidentTypeRef.LogicalName}");
                    }
                    else
                    {
                        Log(LogLevel.Debug, "來源欄位值為 null。");
                    }

                    // 7. 檢查目標欄位是否需要更新
                    bool needsUpdate = false;
                    
                    // 如果目標欄位不存在於 Target 中，需要進行一次查詢取得當前值
                    if (!target.Contains("msdyn_incidenttype") && _context.PreEntityImages.Contains("PreImage"))
                    {
                        Entity preImage = (Entity)_context.PreEntityImages["PreImage"];
                        if (preImage.Contains("msdyn_incidenttype"))
                        {
                            EntityReference currentTargetRef = preImage.GetAttributeValue<EntityReference>("msdyn_incidenttype");
                            
                            if (sourceIncidentTypeRef == null && currentTargetRef != null)
                            {
                                needsUpdate = true;
                            }
                            else if (sourceIncidentTypeRef != null && currentTargetRef == null)
                            {
                                needsUpdate = true;
                            }
                            else if (sourceIncidentTypeRef != null && currentTargetRef != null && 
                                    sourceIncidentTypeRef.Id != currentTargetRef.Id)
                            {
                                needsUpdate = true;
                            }
                        }
                        else
                        {
                            // 如果 PreImage 中沒有目標欄位，則假設需要更新
                            needsUpdate = true;
                        }
                    }
                    else
                    {
                        // 如果沒有 PreImage 或目標欄位已在 Target 中，直接更新
                        needsUpdate = true;
                    }

                    // 8. 執行同步
                    if (needsUpdate)
                    {
                        Log(LogLevel.Info, "開始同步欄位值...");
                        target["msdyn_incidenttype"] = sourceIncidentTypeRef;
                        Log(LogLevel.Info, "同步完成。");
                    }
                    else
                    {
                        Log(LogLevel.Info, "來源與目標欄位值已一致，無需更新。");
                    }
                }
                catch (Exception ex)
                {
                    Log(LogLevel.Error, $"同步 Incident Type 時發生錯誤: {ex.ToString()}");
                    throw new InvalidPluginExecutionException("同步 Incident Type 時發生錯誤，請聯繫管理員。", ex);
                }
            }
            else
            {
                Log(LogLevel.Debug, "此次更新未修改 twtoto_incidenttype1 欄位，無需執行同步。");
            }

            Log(LogLevel.Debug, "離開 IncidentTypeSync ExecuteCore 方法 (Pre-Operation)。");
        }
    }
}
```

## 關鍵實作要點說明

1. **插件註冊設定**：
    
    - 註冊為 Pre-Operation 階段 (Stage 20)
    - 實體：incident
    - 訊息：Update
    - 過濾屬性：twtoto_incidenttype1
    - 設置 PreEntityImage，包含 msdyn_incidenttype 欄位
2. **執行流程與檢查**：
    
    - 檢查訊息類型和實體類型
    - 確保 Target 存在並為 Entity 類型
    - 防止無限循環 (Depth > 1)
    - 檢查是否包含目標欄位
3. **PreEntityImage 的使用**：
    
    - 使用 PreEntityImage 獲取欄位的原始值
    - 這可以避免不必要的資料庫查詢
4. **優化更新邏輯**：
    
    - 只在必要時（來源和目標值不同）進行更新
    - 處理 null 值的情況
5. **完整的錯誤處理與日誌記錄**：
    
    - 記錄每個關鍵步驟
    - 特別標記錯誤和警告
    - 拋出適當的異常，提供充分訊息

## 註冊插件的步驟

1. 打開 Plugin Registration Tool
2. 選擇 Register > Register New Step
3. 設定：
    - Message: Update
    - Primary Entity: incident
    - Event Pipeline Stage of Execution: Pre-Operation
    - Execution Mode: 同步 (Synchronous)
    - Filtering Attributes: twtoto_incidenttype1
4. 註冊 Pre-Entity Image:
    - 名稱：PreImage
    - 包含欄位：msdyn_incidenttype (至少)

這種實作方式在確保數據一致性的同時，最大限度地提高了效率，並且擁有完整的錯誤處理機制與防止循環執行的保護措施。
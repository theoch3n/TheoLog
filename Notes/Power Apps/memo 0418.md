#### ğŸ“… **Date**: 2025-04-18
#### ğŸ”– **Tags**: #PluginAssembly #CSharp #LINQ #Dynamics365 #Dataverse #Automation #PendingOrganization

---
# Plugin ç¨‹å¼ç¢¼è©³è§£ï¼šè‡ªå‹•æŒ‘é¸æœ€ä½³è² è²¬äºº

å¥½çš„ï¼Œæˆ‘å€‘ä¾†è©³ç´°è§£é‡‹é€™æ®µ C# ç¨‹å¼ç¢¼ã€‚é€™æ®µç¨‹å¼ç¢¼çœ‹èµ·ä¾†æ˜¯åœ¨ä¸€å€‹ Dynamics 365 / Dataverse çš„ Plugin æˆ– Custom API çš„å¾Œç«¯é‚è¼¯ä¸­ï¼Œç›®çš„æ˜¯æ ¹æ“šç‰¹å®šè¦å‰‡å¾ä¸€ç¾¤å“¡å·¥ä¸­ï¼Œè‡ªå‹•æŒ‘é¸å‡ºä¸€ä½æœ€é©åˆæ¥æ”¶æ–°é–‹ç™¼é …ç›®çš„ã€Œæœ€ä½³äººé¸ã€ã€‚

**å‡è¨­ï¼š**

-   é€™æ®µç¨‹å¼ç¢¼æ˜¯åœ¨ Plugin çš„ `Execute` æ–¹æ³•å…§éƒ¨ã€‚
-   å·²ç¶“äº‹å…ˆæŸ¥è©¢ä¸¦ç²å–äº† `allTasks` (ä¸€å€‹ `EntityCollection`ï¼ŒåŒ…å«æ‰€æœ‰ç›¸é—œçš„é–‹ç™¼é …ç›®ç´€éŒ„) å’Œ `allEmployees` (ä¸€å€‹ `EntityCollection`ï¼ŒåŒ…å«æ‰€æœ‰å¯è¢«æŒ‡æ´¾çš„å“¡å·¥ç´€éŒ„)ã€‚
-   ç›¸é—œçš„æ¬„ä½é‚è¼¯åç¨± (å¦‚ `TaskOwnerField`, `TaskStatusField`, `EmploymentStartDateField`, `EmployeeNameField`, `EmployeeIdFieldAlias`) å’Œé¸é …é›†å€¼ (å¦‚ `TaskStatusInProgress`, `TaskStatusCompleted`) ä»¥åŠå¯¦é«”åç¨± (`EntityEmployee`)ã€è¼¸å‡ºåƒæ•¸åç¨± (`OutputParam`) éƒ½å·²åœ¨ç¨‹å¼ç¢¼çš„å…¶ä»–åœ°æ–¹å®šç¾©å¥½ï¼ˆä¾‹å¦‚ä½œç‚ºå¸¸æ•¸ï¼‰ã€‚

**ç¨‹å¼ç¢¼é€æ®µè©³è§£ï¼š**

```csharp
// å°‡é–‹ç™¼é …ç›®æŒ‰è² è²¬äººåˆ†çµ„
Dictionary<Guid, List<Entity>> tasksByOwner = allTasks.Entities
    .GroupBy(task => task.GetAttributeValue<EntityReference>(TaskOwnerField).Id)
    .ToDictionary(group => group.Key, group => group.ToList());
tracer.Trace($"å°‡é–‹ç™¼é …ç›®æŒ‰ {tasksByOwner.Count} ä½è² è²¬äººåˆ†çµ„ ");
````

**ç¨‹å¼ç¢¼ç›®çš„ (Dictionary å»ºç«‹è©³è§£)ï¼š**

é€™æ®µç¨‹å¼ç¢¼çš„æ ¸å¿ƒç›®æ¨™æ˜¯å°‡ä¸€å€‹åŒ…å«æ‰€æœ‰ã€Œé–‹ç™¼é …ç›®ã€ç´€éŒ„çš„é›†åˆ (`allTasks.Entities`)ï¼Œæ ¹æ“šæ¯ä¸€ç­†ç´€éŒ„çš„ã€Œé …ç›®è² è²¬äººã€(`TaskOwnerField`) æ¬„ä½ï¼Œé€²è¡Œ**åˆ†çµ„**ï¼Œä¸¦å°‡çµæœæ•´ç†æˆä¸€å€‹**å­—å…¸ (Dictionary)**ã€‚é€™æ¨£åšå¯ä»¥æ–¹ä¾¿å¾ŒçºŒå¿«é€ŸæŸ¥æ‰¾æŸä½ç‰¹å®šè² è²¬äººåä¸‹æœ‰å“ªäº›é–‹ç™¼é …ç›®ã€‚

**é‹ä½œæ­¥é©Ÿè©³è§£ï¼š**

1. **`allTasks.Entities`**:
    - ç¨‹å¼ç¢¼çš„èµ·é»ï¼Œä»£è¡¨åŒ…å«å¤šå€‹ `Entity` ç‰©ä»¶çš„é›†åˆï¼ˆæ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€ç­†ã€Œé–‹ç™¼é …ç›®ã€ç´€éŒ„ï¼‰ã€‚
2. **`.GroupBy(task => task.GetAttributeValue<EntityReference>(TaskOwnerField).Id)`**:
    - **`.GroupBy(...)`**: LINQ æ–¹æ³•ï¼Œä¾æŒ‡å®šçš„ã€Œéµ (Key)ã€å°‡é›†åˆå…ƒç´ åˆ†çµ„ã€‚
    - **`task => ...`**: Lambda è¡¨é”å¼ï¼Œå®šç¾©å¦‚ä½•å¾æ¯å€‹å…ƒç´  (`task`) å–å¾—åˆ†çµ„çš„ã€Œéµã€ã€‚
    - **`task.GetAttributeValue<EntityReference>(TaskOwnerField)`**: è®€å– `task` çš„ `TaskOwnerField` æ¬„ä½å€¼ï¼Œé æœŸç‚º `EntityReference` (è² è²¬äºº Lookup)ã€‚
        - **é‡è¦å‡è¨­ï¼š** å‡è¨­ `TaskOwnerField` å­˜åœ¨ã€æ˜¯ Lookup å‹åˆ¥ä¸”**å¤§éƒ¨åˆ†æœ‰å€¼**ã€‚è‹¥æ¬„ä½ç‚ºç©ºï¼Œç›´æ¥å­˜å– `.Id` æœƒå‡ºéŒ¯ã€‚æ›´ç©©å¥çš„å¯«æ³•éœ€åŠ å…¥ç©ºå€¼æª¢æŸ¥ã€‚
    - **`.Id`**: å¾ `EntityReference` ä¸­æå–ä»£è¡¨è² è²¬äººç´€éŒ„çš„å”¯ä¸€è­˜åˆ¥ç¢¼ (`Guid`)ã€‚
    - **`GroupBy` çµæœï¼š** ç”¢ç”Ÿä¸€å€‹åˆ†çµ„é›†åˆï¼Œæ¯å€‹åˆ†çµ„ (`IGrouping`) åŒ…å«ä¸€å€‹ `Key` (è² è²¬äºº `Guid`) å’Œå±¬æ–¼è©² Key çš„æ‰€æœ‰ `task` Entityã€‚
3. **`.ToDictionary(group => group.Key, group => group.ToList())`**:
    - **`.ToDictionary(...)`**: LINQ æ–¹æ³•ï¼Œå°‡åˆ†çµ„é›†åˆè½‰æ›æˆ `Dictionary`ã€‚
    - **`group => group.Key`**: æŒ‡å®šå­—å…¸çš„ã€Œéµã€ç‚ºåˆ†çµ„çš„ `Key` (è² è²¬äºº `Guid`)ã€‚
    - **`group => group.ToList()`**: æŒ‡å®šå­—å…¸çš„ã€Œå€¼ã€ç‚ºæ¯å€‹åˆ†çµ„å…§æ‰€æœ‰ `task` Entity çµ„æˆçš„ `List<Entity>`ã€‚
4. **`Dictionary<Guid, List<Entity>> tasksByOwner = ...`**:
    - å®£å‘Š `tasksByOwner` è®Šæ•¸å„²å­˜æœ€çµ‚çš„å­—å…¸çµæœã€‚ç¾åœ¨å¯ç”¨è² è²¬äºº `Guid` å¿«é€ŸæŸ¥æ‰¾å…¶è² è²¬çš„ä»»å‹™åˆ—è¡¨ã€‚
5. **`tracer.Trace(...)`**:
    - è¨˜éŒ„ Logï¼Œé¡¯ç¤ºä»»å‹™æŒ‰å¤šå°‘ä½ä¸åŒè² è²¬äººé€²è¡Œäº†åˆ†çµ„ï¼ˆå³å­—å…¸ä¸­çš„æ¢ç›®æ•¸ï¼‰ã€‚

**æ­¤æ­¥é©Ÿç¸½çµç›®çš„ï¼š** å»ºç«‹ä¸€å€‹é«˜æ•ˆçš„æŸ¥è©¢çµæ§‹ (`Dictionary`)ï¼Œä»¥è² è²¬äºº ID ç‚ºç´¢å¼•ï¼Œå„²å­˜å…¶å°æ‡‰çš„ä»»å‹™åˆ—è¡¨ï¼Œç‚ºå¾ŒçºŒè¨ˆç®—å€‹äººä»»å‹™è² è¼‰åšæº–å‚™ã€‚

```csharp
// è¨ˆç®—æ¯ä½å“¡å·¥çš„é–‹ç™¼é …ç›®çµ±è¨ˆæ•¸æ“š
var employeeStats = allEmployees.Entities.Select(employee => {
    Guid employeeId = employee.Id;
    // å¾ tasksByOwner å­—å…¸æŸ¥æ‰¾è©²å“¡å·¥çš„ä»»å‹™åˆ—è¡¨ï¼Œè‹¥ç„¡å‰‡ç‚ºç©ºåˆ—è¡¨
    List<Entity> employeeTasks = tasksByOwner.ContainsKey(employeeId) ? tasksByOwner[employeeId] : new List<Entity>();
    // è¨ˆç®—é€²è¡Œä¸­ä»»å‹™æ•¸ (å®‰å…¨æª¢æŸ¥ OptionSetValue)
    int inProgressCount = employeeTasks.Count(task => task.GetAttributeValue<OptionSetValue>(TaskStatusField)?.Value == TaskStatusInProgress);
    // è¨ˆç®—å·²å®Œæˆä»»å‹™æ•¸
    int completedCount = employeeTasks.Count(task => task.GetAttributeValue<OptionSetValue>(TaskStatusField)?.Value == TaskStatusCompleted);

    // å»ºç«‹åŒ…å«çµ±è¨ˆæ•¸æ“šçš„åŒ¿åç‰©ä»¶
    return new {
        EmployeeEntity = employee,
        InProgressTaskCount = inProgressCount,
        CompletedTaskCount = completedCount,
    };
}).ToList();
```

- **ç›®çš„ï¼š** ç‚ºæ¯ä½å“¡å·¥è¨ˆç®—é—œéµçš„çµ±è¨ˆæ•¸æ“šï¼ˆé€²è¡Œä¸­ä»»å‹™æ•¸ã€å·²å®Œæˆä»»å‹™æ•¸ï¼‰ï¼Œä¸¦èˆ‡å“¡å·¥åŸå§‹è³‡æ–™ä¸€èµ·æ‰“åŒ…ï¼Œä¾›å¾ŒçºŒæ’åºä½¿ç”¨ã€‚

```csharp
// æ’åºæ‰¾å‡ºæœ€ä½³äººé¸
var bestCandidate = employeeStats
    // 1. ä¸»è¦æ’åºï¼šä¾ã€Œé€²è¡Œä¸­ã€æ•¸é‡å‡å†ª
    .OrderBy(stat => stat.InProgressTaskCount)
    // 2. æ¬¡è¦æ’åºï¼šä¾ã€Œå·²å®Œæˆã€æ•¸é‡å‡å†ª
    .ThenBy(stat => stat.CompletedTaskCount)
    // 3. å†æ¬¡è¦æ’åºï¼šä¾ã€Œåˆ°è·æ—¥ã€å‡å†ª (è¶Šæ—©è¶Šå„ªå…ˆ)
    .ThenBy(stat => stat.EmployeeEntity.GetAttributeValue<DateTime>(EmploymentStartDateField))
    // 4. å–æ’åºå¾Œçš„ç¬¬ä¸€ç­†ç´€éŒ„ (æˆ– null)
    .FirstOrDefault();
```

- **ç›®çš„ï¼š** æ ¹æ“šé è¨­è¦å‰‡ï¼ˆå·¥ä½œé‡å°‘ã€è³‡æ­·æ·±è€…å„ªå…ˆï¼‰å°æ‰€æœ‰å“¡å·¥é€²è¡Œæ’åºï¼Œä¸¦é¸å‡ºæœ€ç¬¦åˆæ¢ä»¶çš„é‚£ä¸€ä½ã€‚

```csharp
// è™•ç†æ‰¾åˆ°çš„æœ€ä½³äººé¸
if (bestCandidate != null) {
    Entity bestCandidateEntity = bestCandidate.EmployeeEntity;
    Guid bestCandidateGuid = bestCandidateEntity.Id;
    // å®‰å…¨åœ°å–å¾—å§“åã€å“¡å·¥ç·¨è™Ÿã€åˆ°è·æ—¥ç­‰è³‡è¨Š
    string bestCandidateName = bestCandidateEntity.Contains(EmployeeNameField) ? bestCandidateEntity.GetAttributeValue<string>(EmployeeNameField) : string.Empty;
    string bestCandidateId = bestCandidateEntity.GetAttributeValue<string>(EmployeeIdFieldAlias);
    DateTime startDate = bestCandidateEntity.GetAttributeValue<DateTime>(EmploymentStartDateField);
    // è¨˜éŒ„ Log
    tracer.Trace(<span class="math-inline">"æœ€ä½³äººé¸ \=\> å“¡å·¥ç·¨è™Ÿ\: \{bestCandidateId\}, å§“å\: \{bestCandidateName\}, é–‹ç™¼ä¸­\=\{bestCandidate\.InProgressTaskCount\}, å·²çµæ¡ˆ\=\{bestCandidate\.CompletedTaskCount\}, åˆ°è·æ—¥\=\{startDate\.ToShortDateString\(\)\}"\);
// è¨­å®š Plugin çš„è¼¸å‡ºåƒæ•¸
EntityReference candidateRef \= new EntityReference\(EntityEmployee, bestCandidateGuid\);
context\.OutputParameters\[OutputParam\] \= candidateRef; // å°‡é¸ä¸­çš„å“¡å·¥åƒç…§å›å‚³
tracer\.Trace\(</span>"å°‡è¼¸å‡ºåƒæ•¸è¨­ç‚º EntityReference: LogicalName={candidateRef.LogicalName}, Id={candidateRef.Id}");
}
// else (å¯ä»¥åŠ å…¥æ‰¾ä¸åˆ°äººé¸çš„è™•ç†é‚è¼¯)
```

- **ç›®çš„ï¼š** å¦‚æœæ‰¾åˆ°äº†æœ€ä½³äººé¸ï¼Œå‰‡è¨˜éŒ„å…¶è©³ç´°è³‡è¨Šï¼Œä¸¦å°‡æŒ‡å‘è©²å“¡å·¥çš„ `EntityReference` è¨­å®šç‚º Plugin çš„è¼¸å‡ºåƒæ•¸ (`OutputParameters`)ï¼Œä»¥ä¾¿å‘¼å«æ­¤ Plugin çš„ç¨‹å¼ç¢¼èƒ½æ¥æ”¶åˆ°é€™å€‹æŒ‡æ´¾çµæœã€‚

**æ•´é«”é‚è¼¯ç¸½çµï¼š**

1. **è³‡æ–™æº–å‚™ï¼š** å°‡ä»»å‹™æŒ‰è² è²¬äººåˆ†çµ„ï¼Œæ–¹ä¾¿æŸ¥è©¢ã€‚
2. **æ•¸æ“šçµ±è¨ˆï¼š** è¨ˆç®—æ¯ä½å“¡å·¥çš„ä»»å‹™è² è¼‰ã€‚
3. **æ’åºç¯©é¸ï¼š** æ ¹æ“šã€Œé€²è¡Œä¸­å°‘ -> å·²å®Œæˆå°‘ -> è³‡æ­·æ·±ã€çš„è¦å‰‡æ’åºï¼Œé¸å‡ºæœ€ä½³äººé¸ã€‚
4. **çµæœè¼¸å‡ºï¼š** å°‡é¸å‡ºçš„æœ€ä½³äººé¸ä»¥ `EntityReference` çš„å½¢å¼ï¼Œè¨­å®šç‚º Plugin çš„è¼¸å‡ºåƒæ•¸å›å‚³ã€‚
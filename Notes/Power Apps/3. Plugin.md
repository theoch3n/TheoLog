#### ğŸ“… **Date**: 2025-04-07

#### ğŸ”– **Tags**: #PluginAssembly #PowerApps #Dynamics365 #CSharp 

---
## NuGet å¥—ä»¶
- Microsoft.CrmSdk.CoreAssemblies
- Microsoft.CrmSdk.XrmTooling.PluginRegistrationTool
## IPlugin
`: IPlugin` è¡¨ç¤ºé€™å€‹é¡åˆ¥**å¯¦ä½œ** (implements) äº† `IPlugin` ä»‹é¢ã€‚åœ¨ Dynamics 365 ä¸­ï¼Œä»»ä½•è¦ä½œç‚ºå¤–æ›ç¨‹å¼åŸ·è¡Œçš„é¡åˆ¥éƒ½å¿…é ˆå¯¦ä½œ `IPlugin` ä»‹é¢ã€‚

## è¨­å®šé‡‘é‘°

> å°ˆæ¡ˆçš„å±¬æ€§è£¡
	1. `ç°½ç½²`
	2. å‹¾é¸ `ç°½ç½²çµ„ä»¶`
	3. `æ–°å¢é‡‘é‘°` (ä¸éœ€å¯†ç¢¼)
## å°‡ Plugin dllæª” åŠ å…¥åˆ°ç’°å¢ƒè£¡

> éœ€å…ˆå®‰è£ NuGet `Microsoft.CrmSdk.XrmTooling.PluginRegistrationTool`
> Ctrl + Shift + B å»ºç½®å°ˆæ¡ˆ
> 1. packages è£¡æ‰“é–‹ `PluginRegistration.exe`
> 2. `CREATE NEW CONNECTION`
> 3. ç™»å…¥ä¸¦é¸æ“‡ç’°å¢ƒ
> 4. `Register` -> `Register New Assembly`
> 5. é¸æ“‡ dllæª” ( ~/bin/Debug/*___Plugin Name__*.dll )
> 6. é¸æ“‡ Plugin (è‹¥æœ‰å¤šå€‹ Plugin éƒ½æœƒé¡¯ç¤ºå‡ºä¾†æä¾›é¸æ“‡ã€‚åŒå€‹ Assembly è£¡çš„ Plugin ç„¡æ³•å€‹åˆ¥æ›´æ–°ï¼Œåªèƒ½å…¨éƒ¨æ›´æ–°)
> 7. `Register Selected Plugins`
> 8. å³å¯çœ‹åˆ° Plugin åŠ å…¥åˆ°ç’°å¢ƒè£¡ (å°šæœªåŸ·è¡Œ)

## åŸ·è¡Œ Plugin

> 1. å°æ¬²åŸ·è¡Œ Plugin é»å³éµ
> 2. `Register New Step`
> 3. `Message` é¸æ“‡äº‹ä»¶ (e.g. Create)
> 4. é¸æ“‡è©²äº‹ä»¶ Entity (e.g. xxx_demotable)
> 5. é¸æ“‡åœ¨å“ªå€‹éšæ®µåŸ·è¡Œ (é€šå¸¸é¸ `Post Oreration`)
> 	- PreValidation
> 		Transaction å‰
> 	- PreOperation
> 		Transaction å¾Œ Create records å‰
> 	- PostOperation
> 		Create records å¾Œ

## ç¯„ä¾‹: SimpleTracelog
```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Query;

namespace BasicPlugins
{
    // å¯¦ä½œ IPlugin ä»‹é¢ï¼Œç”¨æ–¼ Dynamics 365 Plugin é–‹ç™¼
    public class SimpleTracelog : IPlugin
    {
        // å¯¦ä½œ IPlugin ä»‹é¢è¦æ±‚çš„ Execute æ–¹æ³•ï¼Œä½œç‚º Plugin çš„é€²å…¥é»
        public void Execute(IServiceProvider serviceProvider)
        {
            #region 1. å–å¾—åŸ·è¡Œç’°å¢ƒèˆ‡æœå‹™
            // å¾ serviceProvider å–å¾—æ’ä»¶åŸ·è¡Œä¸Šä¸‹æ–‡ (IPluginExecutionContext)
            // context åŒ…å«è§¸ç™¼äº‹ä»¶çš„è©³ç´°è³‡è¨Šï¼Œä¾‹å¦‚æ¶‰åŠçš„å¯¦é«”ã€æ“ä½œé¡å‹å’Œè§¸ç™¼çš„ä½¿ç”¨è€…
            IPluginExecutionContext context = (IPluginExecutionContext)serviceProvider.GetService(typeof(IPluginExecutionContext));

            // å¾ serviceProvider å–å¾—çµ„ç¹”æœå‹™å·¥å»  (IOrganizationServiceFactory)
            // ç”¨æ–¼å»ºç«‹èˆ‡ Dynamics 365/Dataverse äº’å‹•çš„çµ„ç¹”æœå‹™ç‰©ä»¶
            IOrganizationServiceFactory serviceFactory = (IOrganizationServiceFactory)serviceProvider.GetService(typeof(IOrganizationServiceFactory));

            // ä½¿ç”¨å·¥å» å»ºç«‹çµ„ç¹”æœå‹™ (IOrganizationService) å¯¦ä¾‹
            // ä»¥è§¸ç™¼äº‹ä»¶çš„ä½¿ç”¨è€…æ¬Šé™ (context.UserId) åŸ·è¡Œæ“ä½œ
            IOrganizationService service = serviceFactory.CreateOrganizationService(context.UserId);

            // å¾ serviceProvider å–å¾—è¿½è¹¤æœå‹™ (ITracingService)
            // ç”¨æ–¼è¨˜éŒ„æ’ä»¶åŸ·è¡Œéç¨‹ä¸­çš„è¨Šæ¯ï¼Œæ–¹ä¾¿é™¤éŒ¯
            ITracingService tracer = (ITracingService)serviceProvider.GetService(typeof(ITracingService));
            #endregion

            #region 2. æ¥­å‹™é‚è¼¯
            // è¨˜éŒ„ä¸€æ¢è¿½è¹¤è¨Šæ¯
            tracer.Trace("SimpleTracelog Activated!");

            // å¾ä¸Šä¸‹æ–‡çš„è¼¸å…¥åƒæ•¸ä¸­å–å¾—è§¸ç™¼äº‹ä»¶çš„ç›®æ¨™å¯¦é«” (Target)
            // ç›®æ¨™å¯¦é«”æ˜¯è§¸ç™¼æ’ä»¶æ“ä½œçš„è¨˜éŒ„ï¼Œä¾‹å¦‚æ­£åœ¨å»ºç«‹æˆ–æ›´æ–°çš„è¨˜éŒ„
            Entity target = (Entity)context.InputParameters["Target"];

            // å»ºç«‹æŸ¥è©¢è¡¨é”å¼ (QueryExpression)ï¼Œç”¨æ–¼æŸ¥è©¢ theo_demotable å¯¦é«”
            QueryExpression query = new QueryExpression()
            {
                EntityName = "theo_demotable",              // æŒ‡å®šæŸ¥è©¢çš„å¯¦é«”åç¨±
                ColumnSet = new ColumnSet("theo_name"),     // æŒ‡å®šæŸ¥è©¢ theo_name æ¬„ä½
                Criteria = new FilterExpression()           // åˆå§‹åŒ–éæ¿¾æ¢ä»¶ï¼Œé¡ä¼¼ SQL çš„ WHERE å­å¥
            };
            // éæ¿¾ theo_name ç­‰æ–¼ "test" çš„è¨˜éŒ„
            //query.Criteria.AddCondition("theo_name", ConditionOperator.Equal, "test");

            // åŸ·è¡ŒæŸ¥è©¢ï¼Œå–å¾—ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„é›†åˆ (EntityCollection)
            EntityCollection result = service.RetrieveMultiple(query);

            // éæ­·æŸ¥è©¢çµæœä¸­çš„æ¯ç­†è¨˜éŒ„
            foreach (Entity record in result.Entities)
            {
                // è¨˜éŒ„æ¯ç­†è¨˜éŒ„çš„ theo_name æ¬„ä½å€¼
                tracer.Trace(record["theo_name"].ToString());
            }

            // å–å¾—æŸ¥è©¢åˆ°çš„è¨˜éŒ„ç¸½æ•¸
            int index = result.Entities.Count;

            // å»ºç«‹ä¸€å€‹æ–°çš„ Entity ç‰©ä»¶ï¼Œç”¨æ–¼æ›´æ–°ç›®æ¨™è¨˜éŒ„
            // ä½¿ç”¨ç›®æ¨™è¨˜éŒ„çš„ Id æŒ‡å®šè¦æ›´æ–°çš„è¨˜éŒ„
            Entity targetToUpdate = new Entity("theo_demotable", target.Id);

            // å°‡æŸ¥è©¢åˆ°çš„è¨˜éŒ„æ•¸é‡è¨­å®šåˆ° theo_index æ¬„ä½
            targetToUpdate["theo_index"] = index;

            // å‘¼å«æœå‹™æ›´æ–°ç›®æ¨™è¨˜éŒ„ï¼Œå°‡è®Šæ›´å„²å­˜åˆ° Dynamics 365
            service.Update(targetToUpdate);
            #endregion
        }
    }
}
```
#### **1. é¡åˆ¥èˆ‡ä»‹é¢**
```csharp
public class SimpleTracelog : IPlugin
```
- SimpleTracelog é¡åˆ¥å¯¦ä½œäº† IPlugin ä»‹é¢ï¼Œé€™æ˜¯ Dynamics 365 Plugin çš„æ¨™æº–è¦æ±‚ã€‚
- IPlugin ä»‹é¢è¦æ±‚å¯¦ä½œ Execute æ–¹æ³•ï¼Œä½œç‚º Plugin çš„å…¥å£é»ã€‚
---
#### **2. Execute æ–¹æ³•**
```csharp
public void Execute(IServiceProvider serviceProvider)
```
- Execute æ–¹æ³•æ˜¯æ’ä»¶è¢«è§¸ç™¼æ™‚ Dynamics 365 æœƒå‘¼å«çš„å…¥å£é»ã€‚
- serviceProvider åƒæ•¸æä¾›äº†æ’ä»¶åŸ·è¡Œæ‰€éœ€çš„å„ç¨®æœå‹™ï¼Œä¾‹å¦‚åŸ·è¡Œä¸Šä¸‹æ–‡ã€çµ„ç¹”æœå‹™å’Œè¿½è¹¤æœå‹™ã€‚
---
#### **3. å–å¾—æœå‹™**
ç¨‹å¼ç¢¼çš„ç¬¬ä¸€éƒ¨åˆ†å¾ serviceProvider ä¸­å–å¾—å¿…è¦çš„æœå‹™ï¼š
```csharp
IPluginExecutionContext context = (IPluginExecutionContext)serviceProvider.GetService(typeof(IPluginExecutionContext));
```
- **ç›®çš„**ï¼šå–å¾— IPluginExecutionContextï¼Œå®ƒåŒ…å«è§¸ç™¼æ’ä»¶çš„äº‹ä»¶çš„è©³ç´°è³‡è¨Šï¼ˆä¾‹å¦‚æ¶‰åŠçš„å¯¦é«”ã€æ“ä½œé¡å‹å¦‚å»ºç«‹æˆ–æ›´æ–°ã€è§¸ç™¼äº‹ä»¶çš„ä½¿ç”¨è€…ç­‰ï¼‰ã€‚
- **ç´°ç¯€**ï¼šä¸Šä¸‹æ–‡æä¾›äº†è¼¸å…¥/è¼¸å‡ºåƒæ•¸ã€ç›®æ¨™å¯¦é«”ç­‰å…ƒè³‡æ–™çš„å­˜å–ã€‚

```csharp
IOrganizationServiceFactory serviceFactory = (IOrganizationServiceFactory)serviceProvider.GetService(typeof(IOrganizationServiceFactory));
IOrganizationService service = serviceFactory.CreateOrganizationService(context.UserId);
```
- **ç›®çš„**ï¼šå»ºç«‹ IOrganizationService å¯¦ä¾‹ï¼Œç”¨æ–¼èˆ‡ Dynamics 365 äº’å‹•ï¼ˆä¾‹å¦‚æŸ¥è©¢ã€å»ºç«‹ã€æ›´æ–°æˆ–åˆªé™¤è¨˜éŒ„ï¼‰ã€‚
- **ç´°ç¯€**ï¼š
    - IOrganizationServiceFactory ç”¨æ–¼å»ºç«‹æœå‹™ã€‚
    - context.UserId ç¢ºä¿æœå‹™ä»¥è§¸ç™¼äº‹ä»¶çš„ä½¿ç”¨è€…æ¬Šé™åŸ·è¡Œæ“ä½œã€‚

```csharp
ITracingService tracer = (ITracingService)serviceProvider.GetService(typeof(ITracingService));
```
- **ç›®çš„**ï¼šå–å¾— ITracingServiceï¼Œç”¨æ–¼è¨˜éŒ„æ’ä»¶åŸ·è¡Œéç¨‹ä¸­çš„è¨Šæ¯ï¼Œæ–¹ä¾¿é™¤éŒ¯ã€‚
- **ç´°ç¯€**ï¼šè¿½è¹¤æ—¥èªŒå¯ä»¥åœ¨ Dynamics 365 çš„è¿½è¹¤æ—¥èªŒä¸­æŸ¥çœ‹ã€‚
---
#### **4. æ¥­å‹™é‚è¼¯**
```csharp
tracer.Trace("SimpleTracelog Activated!");
```
- è¨˜éŒ„ä¸€æ¢è¨Šæ¯ï¼Œç¢ºèªæ’ä»¶å·²å•Ÿå‹•ã€‚

```csharp
Entity target = (Entity)context.InputParameters["Target"];
```
- å¾ InputParameters é›†åˆä¸­å–å¾—è§¸ç™¼äº‹ä»¶çš„ç›®æ¨™å¯¦é«”ã€‚
- **ç´°ç¯€**ï¼š
    - "Target" åƒæ•¸åŒ…å«è§¸ç™¼ Plugin çš„å¯¦é«”è¨˜éŒ„ï¼ˆä¾‹å¦‚æ­£åœ¨å»ºç«‹æˆ–æ›´æ–°çš„ theo_demotable è¨˜éŒ„ï¼‰ã€‚
    - target ç‰©ä»¶è¢«è½‰å‹ç‚º Entity é¡å‹ï¼Œè¡¨ç¤º Dynamics 365 ä¸­çš„ä¸€ç­†è¨˜éŒ„ï¼ŒåŒ…å«å…¶æ¬„ä½ï¼ˆå±¬æ€§ï¼‰ã€‚

```csharp
QueryExpression query = new QueryExpression() { EntityName = "theo_demotable", ColumnSet = new ColumnSet("theo_name"), Criteria = new FilterExpression() };
```
- å»ºç«‹ä¸€å€‹ QueryExpression ç‰©ä»¶ï¼Œç”¨æ–¼æŸ¥è©¢ theo_demotable å¯¦é«”ä¸­çš„è¨˜éŒ„ã€‚
- **ç´°ç¯€**ï¼š
    - EntityNameï¼šæŒ‡å®šæŸ¥è©¢çš„å¯¦é«”ç‚º theo_demotableã€‚
    - ColumnSetï¼šåªæŸ¥è©¢ theo_name æ¬„ä½ã€‚
    - Criteriaï¼šåˆå§‹åŒ–ä¸€å€‹éæ¿¾æ¢ä»¶ï¼ˆé¡ä¼¼ SQL çš„ WHERE å­å¥ï¼‰ï¼Œä½†æ­¤è™•æœªæ·»åŠ å…·é«”æ¢ä»¶ï¼Œå› æ­¤æŸ¥è©¢æ‰€æœ‰è¨˜éŒ„ã€‚

```csharp
//query.Criteria.AddCondition("theo_name", ConditionOperator.Equal, "test");
```
- éæ¿¾æŸ¥è©¢çµæœï¼Œåªè¿”å› theo_name ç­‰æ–¼ "test" çš„è¨˜éŒ„ã€‚

```csharp
EntityCollection result = service.RetrieveMultiple(query);
```
- ä½¿ç”¨ IOrganizationService åŸ·è¡ŒæŸ¥è©¢ï¼Œå–å¾—ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„ã€‚
- **ç´°ç¯€**ï¼š
    - RetrieveMultiple è¿”å›ä¸€å€‹ EntityCollectionï¼ŒåŒ…å«ç¬¦åˆæŸ¥è©¢æ¢ä»¶çš„ Entity ç‰©ä»¶ï¼ˆè¨˜éŒ„ï¼‰æ¸…å–®ã€‚
    - æ­¤è™•æŸ¥è©¢æ‰€æœ‰ theo_demotable è¨˜éŒ„ï¼Œä¸¦åƒ…åŒ…å« theo_name æ¬„ä½ã€‚

```csharp
foreach (Entity record in result.Entities) { 
	tracer.Trace(record["theo_name"].ToString());
}
```
- éæ­· EntityCollection ä¸­çš„æ¯ç­†è¨˜éŒ„ã€‚
- è¨˜éŒ„æ¯ç­†è¨˜éŒ„çš„ theo_name æ¬„ä½å€¼ã€‚
- **ç´°ç¯€**ï¼š
    - record["theo_name"] å­˜å–è¨˜éŒ„çš„ theo_name å±¬æ€§ã€‚
    - .ToString() å°‡å€¼è½‰ç‚ºå­—ä¸²ä»¥è¨˜éŒ„ã€‚

```csharp
int index = result.Entities.Count;
```
- å°‡æŸ¥è©¢åˆ°çš„è¨˜éŒ„æ•¸é‡å„²å­˜åœ¨ index è®Šæ•¸ä¸­ã€‚
- **ç´°ç¯€**ï¼šresult.Entities.Count è¿”å› EntityCollection ä¸­çš„è¨˜éŒ„ç¸½æ•¸ã€‚

```csharp
Entity targetToUpdate = new Entity("theo_demotable", target.Id); targetToUpdate["theo_index"] = index; service.Update(targetToUpdate);
```
- æ›´æ–°ç›®æ¨™è¨˜éŒ„ï¼Œå°‡æŸ¥è©¢åˆ°çš„è¨˜éŒ„æ•¸é‡å¯«å…¥ theo_index æ¬„ä½ã€‚
- **ç´°ç¯€**ï¼š
    - å»ºç«‹ä¸€å€‹æ–°çš„ Entity ç‰©ä»¶ï¼ŒæŒ‡å®šå¯¦é«”ç‚º theo_demotableï¼Œä¸¦ä½¿ç”¨ target.Idï¼ˆç›®æ¨™è¨˜éŒ„çš„å”¯ä¸€è­˜åˆ¥ç¢¼ï¼‰ã€‚
    - å°‡ theo_index æ¬„ä½è¨­ç‚º indexï¼ˆæŸ¥è©¢åˆ°çš„è¨˜éŒ„æ•¸é‡ï¼‰ã€‚
    - å‘¼å« service.Update å°‡è®Šæ›´å„²å­˜åˆ° Dynamics 365ã€‚
---
### **Plugin åŠŸèƒ½ç¸½çµ**

1. **è§¸ç™¼**ï¼šæ’ä»¶åœ¨ theo_demotable å¯¦é«”ä¸Šçš„æŸå€‹äº‹ä»¶ï¼ˆä¾‹å¦‚å»ºç«‹æˆ–æ›´æ–°è¨˜éŒ„ï¼‰è§¸ç™¼ã€‚
2. **è¨˜éŒ„å•Ÿå‹•**ï¼šè¨˜éŒ„ä¸€æ¢è¨Šæ¯ï¼Œç¢ºèªæ’ä»¶å·²å•Ÿå‹•ã€‚
3. **æŸ¥è©¢**ï¼šæŸ¥è©¢ theo_demotable å¯¦é«”ä¸­çš„æ‰€æœ‰è¨˜éŒ„ï¼Œåªå–å¾— theo_name æ¬„ä½ã€‚
4. **è¨˜éŒ„æŸ¥è©¢çµæœ**ï¼šè¨˜éŒ„æ¯ç­†æŸ¥è©¢åˆ°çš„è¨˜éŒ„çš„ theo_name å€¼ï¼Œæ–¹ä¾¿é™¤éŒ¯ã€‚
5. **æ›´æ–°è¨˜éŒ„**ï¼šå°‡æŸ¥è©¢åˆ°çš„è¨˜éŒ„æ•¸é‡æ›´æ–°åˆ°ç›®æ¨™è¨˜éŒ„çš„ theo_index æ¬„ä½ã€‚
#### ğŸ“… **Date**: 2025-04-17

#### ğŸ”– **Tags**: #PendingOrganization

---
`SetDevelopmentTaskStatusPlugin` ä¸­çš„æ ¸å¿ƒé‚è¼¯ï¼Œä¹Ÿå°±æ˜¯æ ¹æ“šå¾å‰ç«¯ JavaScript å‚³ä¾†çš„ `operation` å­—ä¸²ï¼ˆä»£è¡¨ä½¿ç”¨è€…é»æ“Šäº†å“ªå€‹æŒ‰éˆ•ï¼‰ï¼Œä¾†åŸ·è¡Œç›¸å°æ‡‰çš„è³‡æ–™åº«æ›´æ–°æ“ä½œã€‚

```csharp
// æ ¹æ“š operation è®Šæ•¸çš„å€¼ï¼Œè·³åˆ°å°æ‡‰çš„ case å€å¡ŠåŸ·è¡Œ
switch (operation) 
{
    // å¦‚æœ operation çš„å€¼æ˜¯ "Assign"
    case "Assign": 
        // å¯« Log: æ–¹ä¾¿è¿½è¹¤ç¨‹å¼åŸ·è¡Œåˆ°å“ªè£¡
        tracer.Trace("åŸ·è¡Œ Assign æ“ä½œ"); 
        // åœ¨æº–å‚™è¦æ›´æ–°çš„ taskToUpdate ç‰©ä»¶ä¸­ï¼Œè¨­å®šç‹€æ…‹æ¬„ä½ (statusField) çš„å€¼
        // new OptionSetValue(developmentValue) è¡¨ç¤ºå°‡ç‹€æ…‹è¨­ç‚ºã€Œé–‹ç™¼ä¸­ã€å°æ‡‰çš„é¸é …å€¼
        taskToUpdate[statusField] = new OptionSetValue(developmentValue); 
        // åœ¨ taskToUpdate ç‰©ä»¶ä¸­ï¼Œè¨­å®šäº¤æ´¾æ™‚é–“æ¬„ä½ (assignTimeField) çš„å€¼ç‚ºç›®å‰çš„ UTC æ™‚é–“
        taskToUpdate[assignTimeField] = currentTime; 
        // å‘¼å« service.Update() æ–¹æ³•ï¼Œå°‡ taskToUpdate ç‰©ä»¶ä¸­è¨­å®šçš„è®Šæ›´å„²å­˜åˆ° Dataverse è³‡æ–™åº«
        service.Update(taskToUpdate); 
        // å¯« Log: è¨˜éŒ„æ“ä½œå®Œæˆ
        tracer.Trace("é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œé–‹ç™¼ä¸­ã€, ä¸¦è¨˜éŒ„ã€Œäº¤æ´¾æ™‚é–“ã€");
        // break é—œéµå­—è¡¨ç¤ºé€™å€‹ case çš„è™•ç†çµæŸï¼Œè·³å‡º switch èªå¥
        break; 

    // å¦‚æœ operation çš„å€¼æ˜¯ "DevDone"
    case "DevDone":
        tracer.Trace("åŸ·è¡Œ DevDone æ“ä½œ");
        // è¨­å®šç‹€æ…‹ç‚ºã€Œå¾…å¯©æ ¸ã€
        taskToUpdate[statusField] = new OptionSetValue(pendingValue); 
        // è¨˜éŒ„äº¤ä»˜æ™‚é–“
        taskToUpdate[deliverTimeField] = currentTime; 
        // åŸ·è¡Œæ›´æ–°
        service.Update(taskToUpdate); 
        tracer.Trace("é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œå¾…å¯©æ ¸ã€, ä¸¦è¨˜éŒ„ã€Œäº¤ä»˜æ™‚é–“ã€");
        break;

    // å¦‚æœ operation çš„å€¼æ˜¯ "Approve"
    case "Approve":
        tracer.Trace("åŸ·è¡Œ Approve æ“ä½œ");
        // è¨­å®šç‹€æ…‹ç‚ºã€Œçµæ¡ˆã€
        taskToUpdate[statusField] = new OptionSetValue(closedValue); 
        // è¨˜éŒ„çµæ¡ˆæ™‚é–“
        taskToUpdate[closeTimeField] = currentTime; 
        // åŸ·è¡Œæ›´æ–°
        service.Update(taskToUpdate); 
        tracer.Trace("é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œçµæ¡ˆã€, ä¸¦è¨˜éŒ„ã€Œçµæ¡ˆæ™‚é–“ã€");
        break;

    // å¦‚æœ operation çš„å€¼æ˜¯ "Reject"
    case "Reject":
        tracer.Trace("åŸ·è¡Œ Reject æ“ä½œ");
        // å»ºç«‹ä¸€å€‹ OrganizationRequest ç‰©ä»¶ï¼Œæº–å‚™å‘¼å«å¦ä¸€å€‹è‡ªè¨‚çš„ Action
        // rejectActionName è®Šæ•¸å„²å­˜äº†é‚£å€‹ Action çš„åç¨± (ä¾‹å¦‚ "theo_SetRejectSetting")
        OrganizationRequest rejectRequest = new OrganizationRequest(rejectActionName); 
        // è¨­å®šè¦å‚³éçµ¦ theo_SetRejectSetting Action çš„è¼¸å…¥åƒæ•¸ "Target"
        // target è®Šæ•¸æ‡‰è©²æ˜¯å¾ Plugin æœ€é–‹å§‹æ¥æ”¶åˆ°çš„ EntityReference (æŒ‡å‘ç›®å‰çš„ DevelopmentTask)
        // *** æ³¨æ„ï¼šé€™è£¡å¯«çš„æ˜¯ targetï¼Œä½†æ ¹æ“šä¹‹å‰çš„ç¨‹å¼ç¢¼ï¼Œæ‚¨å–å¾—çš„è®Šæ•¸åç¨±æ˜¯ targetRefï¼Œè«‹ç¢ºèªé€™è£¡æ˜¯å¦ä½¿ç”¨äº†æ­£ç¢ºçš„è®Šæ•¸ ***
        rejectRequest["Target"] = target; // æˆ–è€…æ‡‰è©²æ˜¯ targetRef ?
        // å‘¼å« service.Execute() æ–¹æ³•ä¾†åŸ·è¡Œ theo_SetRejectSetting é€™å€‹ Action
        // çœŸæ­£æ¸…ç©ºæ™‚é–“ã€å¢åŠ è¨ˆæ•¸çš„é‚è¼¯æœƒåœ¨é‚£å€‹ Action å°æ‡‰çš„ Plugin (SetRejectSettingPlugin) ä¸­åŸ·è¡Œ
        service.Execute(rejectRequest); 
        tracer.Trace($"åŸ·è¡Œ Action: {rejectActionName}");
        // é€™å€‹ case åªè² è²¬å‘¼å«å¦ä¸€å€‹ Actionï¼Œä¸ç›´æ¥æ›´æ–°ç‹€æ…‹æˆ–æ™‚é–“
        break;

    // å¦‚æœ operation çš„å€¼ä¸æ˜¯ä¸Šé¢ä»»ä½•ä¸€å€‹ case
    default: 
        // å¯« Log: è¨˜éŒ„æ”¶åˆ°äº†æœªçŸ¥çš„æ“ä½œæŒ‡ä»¤
        tracer.Trace($"æœªçŸ¥çš„æ“ä½œ: {operation}");
        // é€™è£¡å¯ä»¥é¸æ“‡æ€§åœ°æ‹‹å‡ºéŒ¯èª¤ (throw new InvalidPluginExecutionException(...)) ä¾†ä¸­æ–·åŸ·è¡Œ
        break; // çµæŸ default è™•ç†
}
```

**ç¸½çµä¾†èªªï¼Œé€™æ®µ `switch` ç¨‹å¼ç¢¼çš„ä½œç”¨æ˜¯ï¼š**

1. **åˆ¤æ–·æ“ä½œé¡å‹ï¼š** æª¢æŸ¥å¾å‰ç«¯æŒ‰éˆ•é»æ“Šå‚³ä¾†çš„ `operation` å­—ä¸²æ˜¯ä»€éº¼ã€‚
2. **åŸ·è¡Œå°æ‡‰æ“ä½œï¼š**
    - å°æ–¼ "Assign", "DevDone", "Approve"ï¼šç›´æ¥æº–å‚™å¥½è¦æ›´æ–°çš„æ¬„ä½å€¼ï¼ˆç‹€æ…‹å’Œå°æ‡‰çš„æ™‚é–“æˆ³ï¼‰ï¼Œç„¶å¾Œå‘¼å« `service.Update()` å°‡è®Šæ›´å¯«å…¥è³‡æ–™åº«ã€‚
    - å°æ–¼ "Reject"ï¼šä¸ç›´æ¥ä¿®æ”¹è³‡æ–™ï¼Œè€Œæ˜¯å»ºç«‹ä¸¦åŸ·è¡Œå¦ä¸€å€‹åç‚º `theo_SetRejectSetting` çš„ Actionï¼Œå°‡è™•ç†é€€å›çš„å…·é«”é‚è¼¯ï¼ˆæ¸…ç©ºæ™‚é–“ã€å¢åŠ è¨ˆæ•¸ç­‰ï¼‰äº¤çµ¦é‚£å€‹ Action å’Œå®ƒå°æ‡‰çš„ Plugin (`SetRejectSettingPlugin`) å»å®Œæˆã€‚
3. **è¨˜éŒ„æ—¥èªŒï¼š** åœ¨æ¯å€‹æ­¥é©Ÿä½¿ç”¨ `tracer.Trace()` è¨˜éŒ„åŸ·è¡Œæƒ…æ³ï¼Œæ–¹ä¾¿è¿½è¹¤å’Œé™¤éŒ¯ã€‚
4. **è™•ç†æœªçŸ¥æ“ä½œï¼š** å¦‚æœå‚³ä¾†çš„ `operation` å­—ä¸²ä¸æ˜¯é æœŸçš„ä»»ä½•ä¸€å€‹ï¼Œå°±é€²å…¥ `default` å€å¡Šè¨˜éŒ„ä¸‹ä¾†ã€‚

---

åœ¨ C# Plugin ä¸­èˆ‡ Dataverse äº’å‹•ï¼Œæˆ‘å€‘ä¸»è¦ä½¿ç”¨ `IOrganizationService` é€™å€‹ä»‹é¢æä¾›çš„å„ç¨®æ–¹æ³•ã€‚å¸¸è¦‹çš„æœ‰ï¼š

- `service.Create(entity)`: æ–°å¢ç´€éŒ„
- `service.Retrieve(entityName, id, columnSet)`: æŸ¥è©¢å–®ç­†ç´€éŒ„
- `service.Update(entity)`: æ›´æ–°ç´€éŒ„
- `service.Delete(entityName, id)`: åˆªé™¤ç´€éŒ„
- `service.RetrieveMultiple(query)`: æŸ¥è©¢å¤šç­†ç´€éŒ„
- **`service.Execute(request)`**: åŸ·è¡Œä¸€å€‹æ›´é€šç”¨çš„ã€Œ**è«‹æ±‚ (Request)**ã€ã€‚

**ç‚ºä»€éº¼åœ¨ "Reject" çš„æƒ…æ³ä¸‹ä½¿ç”¨ `OrganizationRequest` å’Œ `service.Execute()`ï¼Ÿ**

1. **éœ€æ±‚ä¸åŒï¼š** å°æ–¼ "Assign", "DevDone", "Approve" é€™ä¸‰ç¨®æƒ…æ³ï¼Œæˆ‘å€‘çš„éœ€æ±‚æ˜¯ç›´æ¥**æ›´æ–°**ç›®å‰é€™ç­† `DevelopmentTask` ç´€éŒ„çš„**æ¬„ä½**ï¼ˆç‹€æ…‹å’Œæ™‚é–“ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘å€‘æº–å‚™å¥½ä¸€å€‹åŒ…å«è¦æ›´æ–°æ¬„ä½çš„ `Entity` ç‰©ä»¶ (`taskToUpdate`)ï¼Œç„¶å¾Œç›´æ¥å‘¼å« `service.Update(taskToUpdate)` ä¾†å®Œæˆã€‚
    
2. **"Reject" çš„ç‰¹æ®Šéœ€æ±‚ï¼š** æ ¹æ“šæ‚¨çš„åŸå§‹éœ€æ±‚å’Œæˆ‘å€‘çš„è¨è«–ï¼Œç•¶æ“ä½œæ˜¯ "Reject" æ™‚ï¼Œæˆ‘å€‘**ä¸åªæ˜¯**è¦æ›´æ–° `DevelopmentTask` çš„æ¬„ä½ï¼Œè€Œæ˜¯è¦å»è§¸ç™¼**å¦ä¸€å€‹å®Œå…¨ç¨ç«‹çš„ã€æ‚¨åœ¨ Dataverse ä¸­è‡ªè¨‚çš„æµç¨‹**ï¼Œä¹Ÿå°±æ˜¯é‚£å€‹å«åš `theo_SetRejectSetting` çš„ **Custom Action**ã€‚é€™å€‹ Action æœ‰å®ƒè‡ªå·±çš„é‚è¼¯ï¼ˆç”± `SetRejectSettingPlugin` è™•ç†ï¼‰ï¼Œä¾‹å¦‚æ¸…ç©ºäº¤ä»˜æ™‚é–“ã€å¢åŠ ä»»å‹™é€€å›æ¬¡æ•¸ã€å¢åŠ å“¡å·¥é€€ä»¶æ•¸ç­‰ã€‚
    
3. **`service.Execute()` çš„ç”¨é€”ï¼š** `service.Execute()` æ–¹æ³•å°±æ˜¯ç”¨ä¾†åŸ·è¡Œ**éæ¨™æº– CRUD æ“ä½œ**çš„é€šç”¨æ–¹æ³•ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†**åŸ·è¡Œæ‚¨è‡ªè¨‚çš„ Action**ã€‚
    
4. **`OrganizationRequest` çš„ä½œç”¨ï¼š**
    
    - ç•¶æ‚¨è¦ä½¿ç”¨ `service.Execute()` ä¾†åŸ·è¡ŒæŸå€‹ç‰¹å®šçš„ Actionï¼ˆæˆ–å…¶ä»–å…§å»ºçš„é CRUD è¨Šæ¯ï¼‰æ™‚ï¼Œæ‚¨éœ€è¦å…ˆå»ºç«‹ä¸€å€‹ã€Œè«‹æ±‚ç‰©ä»¶ã€ï¼Œå‘Šè¨´ `Execute` æ–¹æ³•æ‚¨åˆ°åº•æƒ³åŸ·è¡Œ**å“ªå€‹** Actionï¼Œä»¥åŠè¦å‚³é**ä»€éº¼åƒæ•¸**çµ¦é‚£å€‹ Actionã€‚
    - `OrganizationRequest` å°±æ˜¯ .NET SDK ä¸­ç”¨ä¾†ä»£è¡¨é€™ç¨®é€šç”¨è«‹æ±‚çš„é¡åˆ¥ã€‚
    - **`new OrganizationRequest(rejectActionName)`**: åœ¨å»ºç«‹ `OrganizationRequest` ç‰©ä»¶æ™‚ï¼Œæ‚¨å¿…é ˆåœ¨å»ºæ§‹å­ (constructor) ä¸­å‚³å…¥æ‚¨è¦åŸ·è¡Œçš„é‚£å€‹ Action çš„**å”¯ä¸€åç¨±** (Unique Name)ï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘å­˜åœ¨ `rejectActionName` è®Šæ•¸è£¡çš„å€¼ (`"theo_SetRejectSetting"`)ã€‚é€™æ¨£ `Execute` æ–¹æ³•æ‰çŸ¥é“è¦å»è§¸ç™¼å“ªä¸€å€‹ Actionã€‚
    - **`rejectRequest["Target"] = targetRef;`**: è‡ªè¨‚ Action é€šå¸¸éœ€è¦è¼¸å…¥åƒæ•¸ã€‚`OrganizationRequest` ç‰©ä»¶æœ‰ä¸€å€‹ `Parameters` é›†åˆï¼ˆå¯ä»¥ç”¨ `[]` ç´¢å¼•å™¨å­˜å–ï¼‰ï¼Œè®“æ‚¨å¯ä»¥è¨­å®šè¦å‚³éçµ¦ Action çš„åƒæ•¸ã€‚é€™è£¡ï¼Œæˆ‘å€‘å°‡åç‚º `"Target"` çš„åƒæ•¸è¨­å®šç‚º `targetRef`ï¼ˆæŒ‡å‘ç•¶å‰ DevelopmentTask çš„ EntityReferenceï¼‰ï¼Œé€™æ¨£ `theo_SetRejectSetting` Action åœ¨åŸ·è¡Œæ™‚å°±èƒ½çŸ¥é“è¦è™•ç†çš„æ˜¯å“ªä¸€ç­†ç´€éŒ„ã€‚

**ç¸½çµï¼š**

å› ç‚ºåœ¨ "Reject" çš„æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘çš„ç›®çš„ä¸æ˜¯åƒå…¶ä»–æƒ…æ³ä¸€æ¨£ç›´æ¥æ›´æ–°æ¬„ä½ï¼Œè€Œæ˜¯è¦å»**å•Ÿå‹•å¦ä¸€å€‹å®šç¾©å¥½çš„æ¥­å‹™æµç¨‹ (Custom Action `theo_SetRejectSetting`)**ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦ä½¿ç”¨ `service.Execute()` é€™å€‹é€šç”¨åŸ·è¡Œæ–¹æ³•ã€‚è€Œç‚ºäº†å‘Šè¨´ `service.Execute()` è¦åŸ·è¡Œå“ªå€‹ Action ä¸¦å‚³éå¿…è¦çš„åƒæ•¸ (`Target`)ï¼Œæˆ‘å€‘å°±éœ€è¦å»ºç«‹ä¸¦è¨­å®šä¸€å€‹ `OrganizationRequest` ç‰©ä»¶ã€‚

å¯ä»¥æŠŠ `service.Update(entity)` çœ‹ä½œæ˜¯å°ˆé–€è™•ç†ã€Œæ›´æ–°ç´€éŒ„ã€é€™å€‹è«‹æ±‚çš„æ·å¾‘ï¼Œè€Œ `service.Execute(request)` å‰‡æ˜¯è™•ç†æ›´å»£æ³›è«‹æ±‚ï¼ˆåŒ…æ‹¬åŸ·è¡Œè‡ªè¨‚ Actionï¼‰çš„é€šç”¨æ–¹æ³•ï¼Œéœ€è¦æ‚¨æ˜ç¢ºåœ°ç”¨ `OrganizationRequest` ä¾†æè¿°è«‹æ±‚çš„å…§å®¹ã€‚

---

`SetRejectSettingPlugin.Execute` æ–¹æ³•çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚

```csharp
try // é–‹å§‹åŸ·è¡Œä¸»è¦æ“ä½œï¼Œè‹¥å‡ºéŒ¯å‰‡è·³åˆ° catch
{
    // 1. ç²å–è§¸ç™¼ Action æ™‚å‚³å…¥çš„ Target åƒæ•¸ (æ‡‰æŒ‡å‘ DevelopmentTask ç´€éŒ„)
    EntityReference targetRef = (EntityReference)context.InputParameters["Target"];
    // 2. è¨˜éŒ„æ”¶åˆ°çš„ Target è³‡è¨Š (é™¤éŒ¯ç”¨)
    tracer.Trace($"æ”¶åˆ°çš„ Target: Entity={targetRef.LogicalName}, ID={targetRef.Id}");

    // 3. æŸ¥è©¢é€™ç­† DevelopmentTask ç´€éŒ„ï¼Œç›®çš„æ˜¯å–å¾—å®ƒç›®å‰çš„ã€Œé€€ä»¶æ¬¡æ•¸ã€å’Œã€Œé …ç›®è² è²¬äººã€
    Entity retrievedTask = service.Retrieve(targetRef.LogicalName, targetRef.Id,
        new ColumnSet(rejectCountField, taskOwnerField)); // rejectCountField="theo_rejectcount", taskOwnerField="theo_taskowner"

    // 4. æº–å‚™ä¸€å€‹ Entity ç‰©ä»¶ï¼Œç”¨ä¾†æ›´æ–° DevelopmentTask
    Entity taskToUpdate = new Entity(targetRef.LogicalName, targetRef.Id);

    // 5. å°‡ã€Œäº¤ä»˜æ™‚é–“ã€æ¬„ä½è¨­ç‚º null (æ¸…ç©º)
    taskToUpdate[deliverTimeField] = null; // deliverTimeField="theo_delivertime"

    // 6. å–å¾—ç›®å‰çš„ã€Œé€€ä»¶æ¬¡æ•¸ã€ï¼Œå¦‚æœç‚º null å‰‡è¦–ç‚º 0
    int currentRejectCount = retrievedTask.GetAttributeValue<int?>(rejectCountField).GetValueOrDefault(); 
    // 7. å°‡æ¬¡æ•¸åŠ  1ï¼Œè¨­å®šåˆ°è¦æ›´æ–°çš„ç‰©ä»¶ä¸­
    taskToUpdate[rejectCountField] = currentRejectCount + 1; 

    // 8. åŸ·è¡Œå° DevelopmentTask ç´€éŒ„çš„æ›´æ–° (å¯«å…¥æ¸…ç©ºçš„äº¤ä»˜æ™‚é–“å’Œå¢åŠ å¾Œçš„é€€ä»¶æ¬¡æ•¸)
    service.Update(taskToUpdate); 
    // 9. è¨˜éŒ„æ›´æ–°æ“ä½œçš„çµæœ (é™¤éŒ¯ç”¨)
    // (é€™è£¡çš„ Log å·²ä¿®æ­£ï¼Œæ›´ç²¾ç¢º)
    tracer.Trace($"æ›´æ–° {targetRef.LogicalName} ID {targetRef.Id}: æ¸…ç©º {deliverTimeField}, è¨­å®š {rejectCountField} ç‚º {currentRejectCount + 1}"); 

    // --- é–‹å§‹è™•ç†é—œè¯çš„å“¡å·¥ç´€éŒ„ ---

    // 10. å¾å…ˆå‰æŸ¥è©¢åˆ°çš„ DevelopmentTask ä¸­ï¼Œç²å–ã€Œé …ç›®è² è²¬äººã€(å“¡å·¥) çš„ EntityReference
    // !!! æ³¨æ„ï¼šé€™è£¡å‡è¨­ taskOwnerField ä¸€å®šæœ‰å€¼ä¸”ä¸ç‚º nullã€‚å¦‚æœè©²æ¬„ä½å¯èƒ½ç‚ºç©ºï¼Œé€™è£¡æœƒå‡ºéŒ¯ !!!
    EntityReference employeeRef = retrievedTask.GetAttributeValue<EntityReference>(taskOwnerField); 
    // 11. è¨˜éŒ„ç²å–åˆ°çš„å“¡å·¥ ID (é™¤éŒ¯ç”¨)
    tracer.Trace($"é …ç›®è² è²¬äººID: {employeeRef.Id}");

    // 12. æŸ¥è©¢é€™ä½å“¡å·¥çš„ç´€éŒ„ï¼Œç›®çš„æ˜¯å–å¾—ç›®å‰çš„ã€Œé–‹ç™¼é …ç›®é€€ä»¶æ•¸ã€
    Entity retrievedEmployee = service.Retrieve(employeeRef.LogicalName, employeeRef.Id,
        new ColumnSet(employeeTaskRejectCountField)); // employeeTaskRejectCountField="theo_taskrejectcount"

    // 13. æº–å‚™ä¸€å€‹ Entity ç‰©ä»¶ï¼Œç”¨ä¾†æ›´æ–°å“¡å·¥ç´€éŒ„
    Entity employeeToUpdate = new Entity(employeeRef.LogicalName, employeeRef.Id);
    
    // 14. å–å¾—ç›®å‰çš„ã€Œé–‹ç™¼é …ç›®é€€ä»¶æ•¸ã€ï¼Œå¦‚æœç‚º null å‰‡è¦–ç‚º 0
    int currentEmployeeRejectCount = retrievedEmployee.GetAttributeValue<int?>(employeeTaskRejectCountField).GetValueOrDefault();

    // 15. å°‡æ¬¡æ•¸åŠ  1ï¼Œè¨­å®šåˆ°è¦æ›´æ–°çš„ç‰©ä»¶ä¸­
    employeeToUpdate[employeeTaskRejectCountField] = currentEmployeeRejectCount + 1; 
    
    // 16. åŸ·è¡Œå°å“¡å·¥ç´€éŒ„çš„æ›´æ–°
    service.Update(employeeToUpdate); 
    // 17. è¨˜éŒ„æ›´æ–°æ“ä½œçš„çµæœ (é™¤éŒ¯ç”¨ï¼Œè¨Šæ¯å·²ä¿®æ­£)
    tracer.Trace($"æ›´æ–° {employeeRef.LogicalName} ID {employeeRef.Id}: å°‡ {employeeTaskRejectCountField} å¾ {currentEmployeeRejectCount} æ›´æ–°ç‚º {currentEmployeeRejectCount + 1}"); 
    
    // 18. è¨˜éŒ„æ•´å€‹ Plugin æˆåŠŸåŸ·è¡Œå®Œç•¢
    tracer.Trace("SetRejectSettingPlugin åŸ·è¡Œå®Œç•¢");
} 
catch (Exception ex) // å¦‚æœ try å€å¡Šä¸­ç™¼ç”Ÿä»»ä½•æœªé æœŸçš„éŒ¯èª¤
{
    // 19. å°‡è©³ç´°çš„éŒ¯èª¤è¨Šæ¯å¯«å…¥ Trace Log
    tracer.Trace($"SetRejectSettingPlugin Error: {ex.ToString()}");
    // !!! æ³¨æ„ï¼šé€™è£¡åªè¨˜éŒ„äº†éŒ¯èª¤ï¼Œä½†æ²’æœ‰å°‡éŒ¯èª¤æ‹‹å‡ºçµ¦å¹³å° !!!
    // æ‡‰è©²åœ¨é€™è£¡åŠ ä¸Š throw new InvalidPluginExecutionException(...)
}

```

**é€æ®µèªªæ˜ï¼š**

1. **ç²å–èˆ‡æŸ¥è©¢ Development Task (1-4è¡Œ):**
    
    - å¾ Action çš„è¼¸å…¥åƒæ•¸ä¸­å–å¾— `Target`ï¼ˆæŒ‡å‘è¢«é€€å›çš„ Development Taskï¼‰ã€‚
    - ä½¿ç”¨ `service.Retrieve` æ–¹æ³•æ ¹æ“š `Target` çš„ IDï¼Œå¾è³‡æ–™åº«æŸ¥è©¢é€™ç­† Development Task ç´€éŒ„ï¼Œä½†åªå–å› `rejectCountField` (`theo_rejectcount`) å’Œ `taskOwnerField` (`theo_taskowner`) é€™å…©å€‹æ¬„ä½çš„å€¼ã€‚
2. **æ›´æ–° Development Task (5-9è¡Œ):**
    
    - å»ºç«‹ä¸€å€‹ `taskToUpdate` ç‰©ä»¶ï¼Œä»£è¡¨è¦æ›´æ–°çš„ Development Taskã€‚
    - å°‡ `deliverTimeField` (`theo_delivertime`) çš„å€¼è¨­ç‚º `null` ä¾†æ¸…ç©ºå®ƒã€‚
    - ä½¿ç”¨ `GetAttributeValue<int?>(rejectCountField).GetValueOrDefault()` å®‰å…¨åœ°å–å¾—ç›®å‰çš„ `theo_rejectcount` å€¼ï¼ˆå¦‚æœæ¬„ä½æ˜¯ç©ºçš„å°±å¾—åˆ° 0ï¼‰ã€‚
    - å°‡å–å¾—çš„æ¬¡æ•¸åŠ  1ï¼Œè¨­å®šå› `rejectCountField`ã€‚
    - å‘¼å« `service.Update(taskToUpdate)` å°‡é€™äº›è®Šæ›´ï¼ˆæ¸…ç©ºæ™‚é–“ã€å¢åŠ æ¬¡æ•¸ï¼‰å„²å­˜å›è³‡æ–™åº«ã€‚
    - è¨˜éŒ„ Log èªªæ˜æ›´æ–°äº†å“ªäº›å…§å®¹ã€‚
3. **ç²å–ä¸¦æ›´æ–° Employee (10-17è¡Œ):**
    
    - å¾ç¬¬ 3 æ­¥æŸ¥è©¢åˆ°çš„ `retrievedTask` ç‰©ä»¶ä¸­ï¼Œè®€å– `taskOwnerField` (`theo_taskowner`) çš„å€¼ï¼Œå¾—åˆ°è² è²¬äºº (å“¡å·¥) çš„ `EntityReference` (`employeeRef`)ã€‚**ï¼ˆæ³¨æ„ï¼šé€™è£¡ç¼ºå°‘å°è² è²¬äººæ˜¯å¦ç‚ºç©ºçš„æª¢æŸ¥ï¼‰**
    - ä½¿ç”¨ `employeeRef` ä¸­çš„ ID å’Œ LogicalNameï¼Œå‘¼å« `service.Retrieve` æŸ¥è©¢å°æ‡‰çš„å“¡å·¥ç´€éŒ„ï¼Œåªå–å› `employeeTaskRejectCountField` (`theo_taskrejectcount`) çš„å€¼ã€‚
    - å»ºç«‹ä¸€å€‹ `employeeToUpdate` ç‰©ä»¶ï¼Œä»£è¡¨è¦æ›´æ–°çš„å“¡å·¥ç´€éŒ„ã€‚
    - åŒæ¨£å®‰å…¨åœ°å–å¾—ç›®å‰çš„ `theo_taskrejectcount` å€¼ä¸¦åŠ  1ã€‚
    - å‘¼å« `service.Update(employeeToUpdate)` å°‡å¢åŠ å¾Œçš„é€€ä»¶æ•¸å„²å­˜å›å“¡å·¥ç´€éŒ„ã€‚
    - è¨˜éŒ„ Log èªªæ˜æ›´æ–°äº†å“¡å·¥çš„å“ªå€‹æ¬„ä½ã€‚
4. **çµæŸèˆ‡éŒ¯èª¤è™•ç† (18-19è¡Œ åŠ catch):**
    
    - å¦‚æœå‰é¢æ‰€æœ‰æ­¥é©Ÿéƒ½æˆåŠŸï¼Œè¨˜éŒ„ Plugin åŸ·è¡Œå®Œç•¢çš„ Logã€‚
    - å¦‚æœåœ¨ `try` å€å¡Šä¸­ä»»ä½•ä¸€æ­¥ç™¼ç”ŸéŒ¯èª¤ï¼ˆä¾‹å¦‚æ¬„ä½ä¸å­˜åœ¨ã€æ¬Šé™ä¸è¶³ã€ç¶²è·¯å•é¡Œç­‰ï¼‰ï¼Œç¨‹å¼æœƒè·³åˆ° `catch` å€å¡Šã€‚
    - `catch` å€å¡Šç›®å‰åªå°‡éŒ¯èª¤è¨Šæ¯å¯«å…¥ Trace Logã€‚**ï¼ˆæ³¨æ„ï¼šé€™è£¡ç¼ºå°‘å°‡éŒ¯èª¤æ‹‹å‡ºçµ¦å¹³å°çš„æ­¥é©Ÿï¼‰**

**ç¸½çµèˆ‡å¾…æ”¹é€²ä¹‹è™•ï¼š**

é€™æ®µç¨‹å¼ç¢¼çš„æ ¸å¿ƒé‚è¼¯æ˜¯æ­£ç¢ºçš„ï¼Œå®Œæˆäº†æ‚¨è¦æ±‚çš„åŠŸèƒ½ã€‚ä½†é‚„æœ‰å…©å€‹ä¸»è¦çš„æ”¹é€²é»å¯ä»¥è®“å®ƒæ›´å¥å£¯ï¼š
1. **æª¢æŸ¥é …ç›®è² è²¬äººæ˜¯å¦ç‚ºç©ºï¼š** åœ¨ç¬¬ 10 è¡Œè®€å– `employeeRef` ä¹‹å‰ï¼Œæ‡‰è©²åŠ å…¥ `if (retrievedTask.Contains(taskOwnerField) && retrievedTask.GetAttributeValue<EntityReference>(taskOwnerField) != null)` åˆ¤æ–·ï¼Œé¿å…åœ¨ä»»å‹™æ²’æœ‰è² è²¬äººæ™‚å‡ºéŒ¯ã€‚
2. **åœ¨ `catch` ä¸­æ‹‹å‡ºéŒ¯èª¤ï¼š** åœ¨ `catch` å€å¡Šçš„ `tracer.Trace(...)` ä¹‹å¾Œï¼ŒåŠ ä¸Š `throw new InvalidPluginExecutionException(...)`ï¼Œé€™æ¨£ç•¶éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œå¹³å°æ‰èƒ½æ­£ç¢ºåœ°è™•ç†ï¼ˆä¾‹å¦‚åœæ­¢æ“ä½œã€å›å¾©äº¤æ˜“ã€æç¤ºä½¿ç”¨è€…ï¼‰ã€‚

ä¿®æ­£é€™å…©é»å¾Œï¼Œæ‚¨çš„ Plugin å°±éå¸¸å®Œå–„äº†ã€‚

---

ç‚ºã€Œé–‹ç™¼é …ç›®ã€(Development Task) æä¾›å››å€‹ç”Ÿå‘½é€±æœŸç®¡ç†æŒ‰éˆ•ï¼ˆäº¤æ´¾ã€é–‹ç™¼å®Œæˆã€é€šéã€é€€å›ï¼‰çš„åŠŸèƒ½ã€‚

**ç¨‹å¼ç¢¼æª”æ¡ˆæ•´é«”çµæ§‹ï¼š**

é€™å€‹ JavaScript æª”æ¡ˆ (å¯èƒ½å«åš `DevelopmentTaskLibrary`) åŒ…å«äº†ï¼š
1. **é¸é …é›†å€¼ (Choices Value) çš„å®šç¾©ï¼š** ä»¥è¨»è§£å’Œå¸¸æ•¸å½¢å¼å®šç¾©äº†ã€Œä»»å‹™ç‹€æ…‹ã€æ¬„ä½çš„ä¸åŒé¸é …å€¼ã€‚
2. **å››çµ„æŒ‰éˆ•å‡½æ•¸ï¼š** æ¯çµ„åŒ…å«ä¸€å€‹ `_enable` å‡½æ•¸ (æ±ºå®šæŒ‰éˆ•æ˜¯å¦å•Ÿç”¨) å’Œä¸€å€‹ `_action` å‡½æ•¸ (æŒ‰éˆ•é»æ“Šå¾ŒåŸ·è¡Œçš„å‹•ä½œ)ã€‚
3. **ä¸€å€‹å…±ç”¨è¼”åŠ©å‡½æ•¸ (`callSetStatusAction`)ï¼š** ç”¨ä¾†åŸ·è¡Œå‘¼å«å¾Œç«¯ Action çš„é‡è¤‡æ€§å·¥ä½œã€‚

**å„éƒ¨åˆ†è©³ç´°è¬›è§£ï¼š**

**1. é¸é …é›†å€¼å®šç¾© (Choices Value)**
```javascript
/** Choices Value
 * éœ€æ±‚ç¢ºèª value: 638540000
 * é–‹ç™¼ä¸­ value: 638540001
 * å¾…å¯©æ ¸ value: 638540002
 * çµæ¡ˆ value: 638540003
 */
// åœ¨å„ _enable å‡½æ•¸ä¸­ä¹Ÿå®šç¾©äº†ç›¸æ‡‰çš„å¸¸æ•¸
```
- **ä½œç”¨ï¼š** æé«˜ç¨‹å¼ç¢¼å¯è®€æ€§ã€‚åœ¨ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨æœ‰æ„ç¾©çš„å¸¸æ•¸åç¨±ï¼ˆå¦‚ `requirementValue`ï¼‰æ¯”ç›´æ¥ä½¿ç”¨æ•¸å­—ï¼ˆå¦‚ `638540000`ï¼‰æ›´å®¹æ˜“ç†è§£ã€‚

**2. äº¤æ´¾ (Assign) æŒ‰éˆ•ç›¸é—œå‡½æ•¸**
```javascript
// #region Assign
async function Assign_action(formContext) {
    console.log("Assign_action called");
    const taskOwnerAttr = formContext.getAttribute("theo_taskowner");
    const taskOwnerValue = taskOwnerAttr ? taskOwnerAttr.getValue() : null; // <- ç¨å¾®å®‰å…¨ä¸€é»çš„å¯«æ³•
    console.log(`äº¤æ´¾çµ¦: ${taskOwnerValue}`); // taskOwnerValue æ˜¯é™£åˆ—æˆ– null

    // !!! ä¸»è¦å•é¡Œé»ï¼šæª¢æŸ¥æ–¹å¼ä¸å®Œæ•´ä¸”ç¼ºå°‘ä½¿ç”¨è€…æç¤º !!!
    if (!taskOwnerValue || taskOwnerValue.length === 0) { // <- æ‡‰æª¢æŸ¥ null æˆ–é•·åº¦ç‚º 0
        // console.error("è«‹å…ˆé¸æ“‡è² è²¬äºº"); // <- åªåœ¨ Console é¡¯ç¤ºï¼Œä½¿ç”¨è€…çœ‹ä¸åˆ°
        Xrm.Navigation.openAlertDialog({ text: "è«‹å…ˆåœ¨ã€Œé …ç›®è² è²¬äººã€æ¬„ä½ä¸­æŒ‡å®šä¸€ä½å“¡å·¥ã€‚" }); // <- å»ºè­°ç”¨é€™å€‹
        return; // ä¸­æ–·åŸ·è¡Œ
    }
    await callSetStatusAction(formContext, "Assign"); // å‘¼å«å…±ç”¨å‡½æ•¸
    console.log("Assign_action ended");
}

function Assign_enable(formContext) {
    console.log("Assign enable called");
    const requirementValue = 638540000; 
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr ? taskStatusAttr.getValue() : null; // <- å»ºè­°åŠ  ? æª¢æŸ¥
    const isEnable = taskStatusValue === requirementValue;
    console.log(`Assign_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, requirementValue: ${requirementValue})`);
    return isEnable; // ç‹€æ…‹ç‚ºã€Œéœ€æ±‚ç¢ºèªã€æ™‚è¿”å› true (å•Ÿç”¨)
}
// #endregion
```
- **`Assign_enable`**: åŠŸèƒ½æ˜¯åˆ¤æ–·ã€Œäº¤æ´¾ã€æŒ‰éˆ•æ˜¯å¦å•Ÿç”¨ã€‚é‚è¼¯æ˜¯æª¢æŸ¥ç›®å‰ç´€éŒ„çš„ `theo_taskstatus` æ˜¯å¦ç­‰æ–¼ã€Œéœ€æ±‚ç¢ºèªã€çš„å€¼ (`638540000`)ã€‚é‚è¼¯æ­£ç¢ºã€‚
- **`Assign_action`**: æŒ‰éˆ•è¢«é»æ“Šæ™‚åŸ·è¡Œã€‚
    - å®ƒæœƒå…ˆæª¢æŸ¥ `theo_taskowner` (é …ç›®è² è²¬äºº) æ¬„ä½æ˜¯å¦æœ‰å€¼ã€‚**ç›®å‰çš„æª¢æŸ¥é‚è¼¯ (`if (!taskOwnerValue)`) éœ€è¦æ”¹é€²**ï¼Œæ‡‰æ”¹ç‚º `if (!taskOwnerValue || taskOwnerValue.length === 0)` ä¾†æ­£ç¢ºè™•ç†ç©ºå€¼æˆ–ç©ºé™£åˆ—çš„æƒ…æ³ã€‚
    - å¦‚æœæª¢æŸ¥æœªé€šéï¼Œç›®å‰åªåœ¨ Console å°å‡ºéŒ¯èª¤ï¼Œ**å»ºè­°æ”¹ç”¨ `Xrm.Navigation.openAlertDialog` å½ˆçª—æç¤ºä½¿ç”¨è€…**ã€‚
    - å¦‚æœæª¢æŸ¥é€šéï¼Œå®ƒæœƒå‘¼å« `callSetStatusAction` å‡½æ•¸ï¼Œè¦æ±‚å¾Œç«¯åŸ·è¡Œ `"Assign"` æ“ä½œã€‚

**3. é–‹ç™¼å®Œæˆ (DevDone) æŒ‰éˆ•ç›¸é—œå‡½æ•¸**
```javascript
// #region DevDone
async function DevDone_action(formContext) {
    console.log("DevDone_action called");
    await callSetStatusAction(formContext, "DevDone"); // å‘¼å«å…±ç”¨å‡½æ•¸ï¼Œå‚³å…¥ "DevDone"
    console.log("DevDone_action ended");
}

function DevDone_enable(formContext) {
    console.log("DevDone enable called");
    const developmentValue = 638540001; 
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr ? taskStatusAttr.getValue() : null; // <- å»ºè­°åŠ  ? æª¢æŸ¥
    const isEnable = taskStatusValue === developmentValue;
    // !!! Log è¨Šæ¯ä¿®æ­£å»ºè­° !!!
    console.log(`DevDone_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, developmentValue: ${developmentValue})`);
    return isEnable; // ç‹€æ…‹ç‚ºã€Œé–‹ç™¼ä¸­ã€æ™‚è¿”å› true (å•Ÿç”¨)
}
// #endregion
```
- **`DevDone_enable`**: é‚è¼¯æ­£ç¢ºï¼Œæª¢æŸ¥ç‹€æ…‹æ˜¯å¦ç‚ºã€Œé–‹ç™¼ä¸­ã€(`638540001`)ã€‚(å°å»ºè­°ï¼šä¿®æ­£ Log ä¸­çš„éŒ¯å­— `Assign_enable:` -> `DevDone_enable:`)ã€‚
- **`DevDone_action`**: é‚è¼¯æ­£ç¢ºï¼Œç›´æ¥å‘¼å« `callSetStatusAction` ä¸¦å‚³å…¥æ“ä½œ `"DevDone"`ã€‚

**4. é€šé (Approve) æŒ‰éˆ•ç›¸é—œå‡½æ•¸**
```javascript
// #region Approve
async function Approve_action(formContext) {
    console.log("Approve_action called");
    await callSetStatusAction(formContext, "Approve"); // å‘¼å«å…±ç”¨å‡½æ•¸ï¼Œå‚³å…¥ "Approve"
    console.log("Approve_action ended");
}

function Approve_enable(formContext) {
    console.log("Approve enable called");
    const pendingValue = 638540002; 
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr ? taskStatusAttr.getValue() : null; // <- å»ºè­°åŠ  ? æª¢æŸ¥
    const isEnable = taskStatusValue === pendingValue;
    // !!! Log è¨Šæ¯ä¿®æ­£å»ºè­° !!!
    console.log(`Approve_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, pendingValue: ${pendingValue})`);
    return isEnable; // ç‹€æ…‹ç‚ºã€Œå¾…å¯©æ ¸ã€æ™‚è¿”å› true (å•Ÿç”¨)
}
// #endregion
```
- **`Approve_enable`**: é‚è¼¯æ­£ç¢ºï¼Œæª¢æŸ¥ç‹€æ…‹æ˜¯å¦ç‚ºã€Œå¾…å¯©æ ¸ã€(`638540002`)ã€‚(å°å»ºè­°åŒä¸Š)ã€‚
- **`Approve_action`**: é‚è¼¯æ­£ç¢ºï¼Œç›´æ¥å‘¼å« `callSetStatusAction` ä¸¦å‚³å…¥æ“ä½œ `"Approve"`ã€‚

**5. é€€å› (Reject) æŒ‰éˆ•ç›¸é—œå‡½æ•¸**
```javascript
// #region Reject
async function Reject_action(formContext) {
    console.log("Reject_action called");
    await callSetStatusAction(formContext, "Reject"); // å‘¼å«å…±ç”¨å‡½æ•¸ï¼Œå‚³å…¥ "Reject"
    console.log("Reject_action ended");
}

function Reject_enable(formContext) {
    console.log("Reject enable called");
    const pendingValue = 638540002; // èˆ‡ Approve å…±ç”¨ã€Œå¾…å¯©æ ¸ã€ç‹€æ…‹
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr ? taskStatusAttr.getValue() : null; // <- å»ºè­°åŠ  ? æª¢æŸ¥
    const isEnable = taskStatusValue === pendingValue;
    // !!! Log è¨Šæ¯ä¿®æ­£å»ºè­° !!!
    console.log(`Reject_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, pendingValue: ${pendingValue})`);
    return isEnable; // ç‹€æ…‹ç‚ºã€Œå¾…å¯©æ ¸ã€æ™‚è¿”å› true (å•Ÿç”¨)
}
// #endregion
```
- **`Reject_enable`**: é‚è¼¯æ­£ç¢ºï¼Œæª¢æŸ¥ç‹€æ…‹æ˜¯å¦ç‚ºã€Œå¾…å¯©æ ¸ã€(`638540002`)ã€‚(å°å»ºè­°åŒä¸Š)ã€‚
- **`Reject_action`**: é‚è¼¯æ­£ç¢ºï¼Œç›´æ¥å‘¼å« `callSetStatusAction` ä¸¦å‚³å…¥æ“ä½œ `"Reject"`ã€‚

**6. å…±ç”¨å‡½æ•¸ `callSetStatusAction`**
```javascript
// #region Call Action SetDevelopmentTaskStatus
async function callSetStatusAction(formContext, operation) { // å»ºè­°åŠ å…¥ç¬¬ä¸‰åƒæ•¸ progressMessage
    console.log("åŸ·è¡Œ callSetStatusAction");
    // !!! å»ºè­°åŠ å…¥ recordId æª¢æŸ¥ !!!
    const recordId = formContext.data.entity.getId().replace(/[{}]/g, ""); // æ­£ç¢ºå–å¾—ä¸¦æ¸…ç† ID
    if (!recordId) { /* ...æç¤ºå…ˆå„²å­˜... */ return; } 
    console.log("recordId:", recordId);
    const entityName = formContext.data.entity.getEntityName(); // æ­£ç¢ºå–å¾—å¯¦é«”å
    const actionName = "theo_SetDevelopmentTaskStatus"; // !!! å¾…ç¢ºèªåç¨± !!!
    const request = { /* ... çµæ§‹æ­£ç¢º ... */ }; // å…§éƒ¨ Request çµæ§‹ (Target, Operation, getMetadata) æ­£ç¢º
    console.log("request:", request);

    // !!! ä¸»è¦å•é¡Œé»ï¼šç¼ºå°‘ try...catch å’Œä½¿ç”¨è€…éŒ¯èª¤æç¤º !!!
    try { // <-- å»ºè­°åŠ å…¥ try
        // Xrm.Utility.showProgressIndicator(operation + "..."); // <-- å»ºè­°åŠ å…¥é€²åº¦æç¤º
        const response = await Xrm.WebApi.online.execute(request); // æ­£ç¢ºä½¿ç”¨ await
        if (response.ok) { // æ­£ç¢ºæª¢æŸ¥å›æ‡‰
            console.log(`Action '${actionName}' åŸ·è¡ŒæˆåŠŸ, Status code: ${response.status}`);
            // Xrm.Utility.closeProgressIndicator(); // <-- å»ºè­°åŠ å…¥é—œé–‰æç¤º
            formContext.data.refresh(true); // æ­£ç¢ºåˆ·æ–°
            console.log("é é¢å·²é‡æ–°æ•´ç†");
        } else {
            const error = await response.json(); // æ­£ç¢ºä½¿ç”¨ await è§£æéŒ¯èª¤
            console.log(`Action '${actionName}' åŸ·è¡Œå¤±æ•—, Status code: ${response.status}`, error);
            // Xrm.Utility.closeProgressIndicator(); // <-- å»ºè­°åŠ å…¥é—œé–‰æç¤º
            // Xrm.Navigation.openErrorDialog(...); // <-- å»ºè­°åŠ å…¥éŒ¯èª¤å½ˆçª—
        }
    } catch (error) { // <-- å»ºè­°åŠ å…¥ catch
        console.error(`åŸ·è¡Œ Action '${actionName}' æ™‚ç™¼ç”Ÿä¾‹å¤–éŒ¯èª¤:`, error);
        // Xrm.Utility.closeProgressIndicator(); // <-- å»ºè­°åŠ å…¥é—œé–‰æç¤º
        // Xrm.Navigation.openErrorDialog(...); // <-- å»ºè­°åŠ å…¥éŒ¯èª¤å½ˆçª—
    } // <-- å»ºè­°åŠ å…¥ catch çµæŸ
}
// #endregion
```
- **ä½œç”¨ï¼š** é€™æ˜¯æ ¸å¿ƒçš„è¼”åŠ©å‡½æ•¸ï¼Œè² è²¬å¯¦éš›å‘¼å«å¾Œç«¯çš„ `theo_SetDevelopmentTaskStatus` Actionã€‚
- **å„ªé»ï¼š**
    - æˆåŠŸåœ°å¾ `formContext` æå–äº† `recordId` å’Œ `entityName`ã€‚
    - æ­£ç¢ºåœ°æ§‹å»ºäº†å‘¼å« Action æ‰€éœ€çš„ `request` ç‰©ä»¶ï¼ŒåŒ…å«äº† `Target` (æŒ‡å‘ç›®å‰ç´€éŒ„) å’Œ `Operation` (æ“ä½œé¡å‹) å…©å€‹è¼¸å…¥åƒæ•¸ï¼Œä»¥åŠ `getMetadata` æè¿°è³‡è¨Šã€‚
    - **æœ€é—œéµçš„æ˜¯ï¼Œæ­£ç¢ºåœ°ä½¿ç”¨äº† `await`** ä¾†ç­‰å¾… `Xrm.WebApi.online.execute(request)` é€™å€‹éåŒæ­¥æ“ä½œå®Œæˆï¼Œä¸¦ç²å– `response` ç‰©ä»¶ã€‚
    - èƒ½æ ¹æ“š `response.ok` åˆ¤æ–·å¾Œç«¯ Action æ˜¯å¦æˆåŠŸåŸ·è¡Œ (HTTP ç‹€æ…‹ç¢¼ 2xx)ã€‚
    - æˆåŠŸæ™‚æœƒå‘¼å« `formContext.data.refresh(true)` åˆ·æ–°é é¢ã€‚
    - å¤±æ•—æ™‚èƒ½ä½¿ç”¨ `await response.json()` è§£æéŒ¯èª¤å…§å®¹ã€‚
- **å¾…æ”¹é€²ä¹‹è™•ï¼š**
    - **ç¼ºå°‘ `try...catch`ï¼š** æ•´å€‹ç¶²è·¯è«‹æ±‚å’Œå¾ŒçºŒè™•ç†æ²’æœ‰è¢« `try...catch` åŒ…è£¹ï¼Œå¦‚æœç™¼ç”Ÿç¶²è·¯éŒ¯èª¤æˆ– `execute` å…§éƒ¨éŒ¯èª¤ï¼Œæœƒå°è‡´æœªæ•æ‰çš„ Promise éŒ¯èª¤ã€‚
    - **ç¼ºå°‘ä½¿ç”¨è€…éŒ¯èª¤æç¤ºï¼š** ç•¶ `response.ok` ç‚º `false` æˆ– `catch` åˆ°éŒ¯èª¤æ™‚ï¼Œåªåœ¨ Console æ‰“å°æ—¥èªŒï¼Œæ²’æœ‰å½ˆçª—å‘ŠçŸ¥ä½¿ç”¨è€…æ“ä½œå¤±æ•—ã€‚æ‡‰ä½¿ç”¨ `Xrm.Navigation.openErrorDialog`ã€‚
    - **ç¼ºå°‘ `recordId` æª¢æŸ¥ï¼š** å¦‚æœåœ¨æœªå„²å­˜çš„è¡¨å–®ä¸ŠåŸ·è¡Œï¼Œ`recordId` æœƒæ˜¯ç©ºçš„ï¼Œæ‡‰è©²åœ¨é–‹é ­åŠ ä¸Šæª¢æŸ¥ã€‚
    - **(å¯é¸) ç¼ºå°‘é€²åº¦æç¤ºï¼š** å¯ä»¥åŠ å…¥ `Xrm.Utility.showProgressIndicator` / `closeProgressIndicator` æå‡ä½¿ç”¨è€…é«”é©—ã€‚

**ç¸½çµä¾†èªªï¼Œé€™ä»½ JavaScript ç¨‹å¼ç¢¼å®šç¾©äº†æŒ‰éˆ•çš„å•Ÿç”¨æ¢ä»¶å’Œé»æ“Šå‹•ä½œï¼Œä¸¦é€éä¸€å€‹å…±ç”¨å‡½æ•¸ä¾†å‘¼å«å¾Œç«¯ã€‚ä¸»è¦çš„åŠŸèƒ½é‚è¼¯å·²ç¶“å¯¦ç¾ï¼Œç‰¹åˆ¥æ˜¯ `await` çš„ä½¿ç”¨æ˜¯æ­£ç¢ºçš„ã€‚åªéœ€é‡å° `Assign_action` çš„æª¢æŸ¥é‚è¼¯å’Œ `callSetStatusAction` çš„éŒ¯èª¤è™•ç†ã€ä½¿ç”¨è€…æç¤ºé€²è¡Œå®Œå–„ï¼Œå°±èƒ½è®“æ•´å€‹åŠŸèƒ½æ›´åŠ å¥å£¯ã€ä½¿ç”¨è€…é«”é©—æ›´å¥½ã€‚**

---

Dynamics 365 Custom API èˆ‡è³‡æ–™å‹åˆ¥çš„ Deep Dive å…§å®¹ï¼š

**æ ¸å¿ƒä¸»é¡Œï¼š**

æ·±å…¥æ¢è¨ Microsoft Dynamics 365 ä¸­çš„è‡ªè¨‚ API (Custom API)ï¼Œç‰¹åˆ¥æ˜¯å…¶åƒæ•¸çš„å„ç¨®è³‡æ–™å‹åˆ¥ï¼Œä»¥åŠå¦‚ä½•é€éå‰ç«¯ JavaScript ä¸­çš„ `Xrm.WebApi.online.execute` å’Œ `Xrm.WebApi.retrieveMultipleRecords` æ–¹æ³•èˆ‡é€™äº› API åŠ Dataverse è³‡æ–™äº’å‹•ã€‚

**ä¸»è¦å…§å®¹èˆ‡é‡é»ï¼š**

1. **è‡ªè¨‚ API (Custom API) çš„æ¦‚å¿µï¼š**
    
    - æ˜¯åœ¨ Dynamics 365 ä¸­å»ºç«‹æ‚¨è‡ªå·±çš„ã€å¯é‡è¤‡ä½¿ç”¨çš„ã€Œå‹•ä½œ (Action)ã€æˆ–ã€Œå‡½æ•¸ (Function)ã€ã€‚
    - å„ªé»æ˜¯å°‡å¸¸ç”¨æˆ–è¤‡é›œçš„é‚è¼¯å°è£èµ·ä¾†ï¼Œä½¿ç¨‹å¼ç¢¼æ›´æ¨¡çµ„åŒ–ã€ä¹¾æ·¨ã€æ˜“æ–¼ç¶­è­·ï¼Œé¿å…åœ¨ä¸åŒçš„ Web Resource æˆ– Plugin ä¸­é‡è¤‡æ’°å¯«ã€‚
    - å…·æœ‰æ˜ç¢ºå®šç¾©çš„è¼¸å…¥åƒæ•¸ (Request Parameters) å’Œè¼¸å‡ºå±¬æ€§ (Response Properties)ã€‚
    - æ¯å€‹åƒæ•¸ï¼ˆè¼¸å…¥æˆ–è¼¸å‡ºï¼‰éƒ½æœ‰**ç‰¹å®šçš„è³‡æ–™å‹åˆ¥**ã€‚
2. **Custom API åƒæ•¸çš„å¸¸è¦‹è³‡æ–™å‹åˆ¥ï¼š**
    
    - **åŸºç¤å‹åˆ¥ï¼š**
        - `Boolean` (å¸ƒæ—å€¼ true/false)
        - `DateTime` (æ—¥æœŸèˆ‡æ™‚é–“)
        - `Decimal`, `Money` (æ•¸å€¼ï¼Œå…©è€…åœ¨ Metadata ä¸­ç›¸ä¼¼)
        - `Float`, `Integer` (å…¶ä»–æ•¸å€¼)
        - `String` (æ–‡å­—)
        - `String[]` (æ–‡å­—é™£åˆ—/åˆ—è¡¨)
        - `Guid` (å…¨åŸŸå”¯ä¸€è­˜åˆ¥ç¢¼ï¼Œç”¨æ–¼ç´€éŒ„ ID)
    - **Dynamics 365 ç‰¹å®šå‹åˆ¥ï¼š**
        - `Entity` (ä»£è¡¨ä¸€ç­†å®Œæ•´çš„ç´€éŒ„ï¼ŒåŒ…å«æ‰€æœ‰æ¬„ä½)
        - `EntityCollection` (ä»£è¡¨å¤šç­† `Entity` ç´€éŒ„çš„é›†åˆ/åˆ—è¡¨ï¼Œå¸¸ç”¨æ–¼æŸ¥è©¢çµæœ)
        - `EntityReference` (ä»£è¡¨ä¸€å€‹æŒ‡å‘ç‰¹å®šç´€éŒ„çš„è¼•é‡ç´šã€Œåƒç…§ã€æˆ–ã€ŒæŒ‡æ¨™ã€ï¼ŒåªåŒ…å« ID å’Œå¯¦é«”é¡å‹ï¼Œæ•ˆç‡é«˜)
        - `Picklist` (é¸é …çµ„ Option Setï¼ŒMetadata ä¸­èˆ‡ `Integer` ç›¸ä¼¼)
    - **å‹åˆ¥æç¤ºï¼š** å°æ–¼ `Entity`, `EntityReference` å‹åˆ¥ï¼Œå¯ä»¥æŒ‡å®šå¯¦é«”çš„é‚è¼¯åç¨± (å¦‚ account, contact)ï¼Œè‹¥æŒ‡å®šï¼Œå‰‡å‚³å…¥çš„è³‡æ–™éœ€è¦ç¬¦åˆè©²å¯¦é«”é¡å‹ã€‚
3. **å¾ JavaScript å‘¼å« Custom API (`Xrm.WebApi.online.execute`)ï¼š**
    
    - é€™æ˜¯å¾å‰ç«¯ JavaScript è§¸ç™¼ Custom APIã€æ¨™æº– Action/Function æˆ–åŸ·è¡Œ CRUD æ“ä½œçš„ä¸»è¦æ–¹æ³•ã€‚
    - éœ€è¦å»ºç«‹ä¸€å€‹ `request` ç‰©ä»¶ä¾†æè¿°è«‹æ±‚å…§å®¹ã€‚
    - **`request` ç‰©ä»¶ä¸­çš„ `getMetadata` æ–¹æ³•æ˜¯é—œéµï¼š**
        - ç”¨ä¾†å®šç¾©æ“ä½œçš„ç°½ç«  (Signature)ã€‚
        - `boundParameter`: è‹¥ Action/Function æ˜¯**ç¹«çµ (Bound)** åˆ°æŸå¯¦é«”ç´€éŒ„ï¼Œå‰‡å¡«å…¥ä»£è¡¨è©²å¯¦é«”çš„åƒæ•¸åï¼›è‹¥æ˜¯**æœªç¹«çµ (Unbound)** çš„å…¨åŸŸ Action/Functionï¼Œå‰‡ç‚º `null`ã€‚
        - `parameterTypes`: æè¿°**è¼¸å…¥åƒæ•¸**çš„ OData å‹åˆ¥ã€‚
            - `typeName`: æŒ‡å®šåƒæ•¸çš„ EDM å‹åˆ¥åç¨± (å¦‚ `Edm.String`, `Edm.DateTimeOffset`, `Edm.Decimal` (ç”¨æ–¼ Money), `Edm.Boolean`, `Edm.Double` (ç”¨æ–¼ Float), `Edm.Int32` (ç”¨æ–¼ Integer/Picklist), `Edm.Guid`, `mscrm.crmbaseentity` (ç”¨æ–¼ Entity/EntityReference), `Collection(mscrm.crmbaseentity)` (ç”¨æ–¼ EntityCollection), `Collection(Edm.String)` (ç”¨æ–¼ String Array) ç­‰)ã€‚
            - `structuralProperty`: ç”¨æ•¸å­—è¡¨ç¤ºåƒæ•¸çš„çµæ§‹ (1=åŸºç¤å‹åˆ¥ Primitive, 4=é›†åˆ Collection, 5=å¯¦é«” Entity)ã€‚
        - `operationType`: æŒ‡å®šæ“ä½œé¡å‹ (0=Action, 1=Function, 2=CRUD)ã€‚
        - `operationName`: æŒ‡å®šè¦å‘¼å«çš„ Action/Function çš„åç¨±ã€‚
    - **å›æ‡‰è™•ç†ï¼š** `execute` å›å‚³ä¸€å€‹ Promiseã€‚æˆåŠŸæ™‚ï¼Œå›å‘¼å‡½æ•¸æœƒæ”¶åˆ°ä¸€å€‹åŒ…å« `ok` (true/false)ã€`status` (HTTP ç‹€æ…‹ç¢¼) ä»¥åŠ `json()` æˆ– `text()` æ–¹æ³•ï¼ˆç”¨ä¾†éåŒæ­¥å–å¾—å›æ‡‰å…§å®¹ï¼‰çš„ç‰©ä»¶ã€‚éœ€è¦è™•ç†æˆåŠŸå’Œå¤±æ•—çš„æƒ…æ³ã€‚
4. **åœ¨ Plugin ä¸­è™•ç† Custom API è¼¸å…¥/è¼¸å‡ºï¼š**
    
    - é€é `context.InputParameters` é›†åˆè®€å–å¾å‰ç«¯æˆ–å…¶ä»–åœ°æ–¹å‚³å…¥çš„åƒæ•¸ã€‚
    - éœ€è¦å°‡è®€å–åˆ°çš„å€¼**è½‰æ› (Cast)** æˆæ­£ç¢ºçš„ .NET å‹åˆ¥ (å¦‚ `string`, `Money`, `DateTime`, `int`, `double`, `OptionSetValue`, `string[]`, `Entity`, `EntityReference`, `EntityCollection`)ã€‚
    - é€é `context.OutputParameters` é›†åˆè¨­å®šè¦å›å‚³çµ¦å‘¼å«ç«¯çš„è¼¸å‡ºå€¼ã€‚
    - ä½¿ç”¨ `ITracingService` è¨˜éŒ„ Log éå¸¸é‡è¦ï¼Œä¾¿æ–¼é™¤éŒ¯ã€‚
5. **æŸ¥è©¢å¤šç­†ç´€éŒ„ (`Xrm.WebApi.retrieveMultipleRecords`)ï¼š**
    
    - å°ˆé–€ç”¨æ–¼å¾ç‰¹å®šå¯¦é«”å–å›ç´€éŒ„é›†åˆã€‚
    - éœ€è¦æä¾› `entityLogicalName` (å¯¦é«”é‚è¼¯åç¨±)ã€‚
    - å¯é¸çš„ `options` åƒæ•¸ç”¨ä¾†æŒ‡å®šæŸ¥è©¢æ¢ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ **OData** èªæ³• (`$select`, `$filter`, `$top`, `$expand`, `$orderby`) æˆ– **FetchXML** æŸ¥è©¢å­—ä¸²ã€‚
        - `$select`: æŒ‡å®šåªå–å›éœ€è¦çš„æ¬„ä½ï¼Œå°æ•ˆèƒ½è‡³é—œé‡è¦ã€‚
        - `$expand`: åœ¨åŒä¸€æ¬¡è«‹æ±‚ä¸­å–å›é—œè¯ç´€éŒ„çš„è³‡æ–™ã€‚
    - å¯é¸çš„ `maxPageSize` æ§åˆ¶æ¯é è¿”å›çš„ç´€éŒ„æ•¸é‡ (é è¨­æœ€å¤š 5000)ã€‚
    - **åˆ†é è™•ç†ï¼š**
        - æˆåŠŸçš„å›æ‡‰åŒ…å« `entities` å±¬æ€§ (ç•¶å‰é çš„ç´€éŒ„é™£åˆ—)ã€‚
        - è‹¥é‚„æœ‰æ›´å¤šç´€éŒ„ï¼š
            - OData: å›æ‡‰æœƒåŒ…å« `nextLink` å±¬æ€§ (ä¸‹ä¸€é è³‡æ–™çš„ URL)ï¼Œå†æ¬¡å‘¼å« `retrieveMultipleRecords` ä¸¦å°‡æ­¤ URL ä½œç‚º `options` å‚³å…¥å³å¯å–å¾—ä¸‹ä¸€é ã€‚
            - FetchXML (ç·šä¸Šç’°å¢ƒ): å¯èƒ½æœƒå›å‚³ `WorkspaceXmlPagingCookie`ï¼Œå°‡æ­¤ Cookie åŠ å…¥ä¸‹ä¸€æ¬¡çš„ FetchXML æŸ¥è©¢ä¸­ä¾†å–å¾—ä¸‹ä¸€é  (é›¢ç·šæ¨¡å¼ä¸æ”¯æ´ Cookie)ã€‚
    - **é›¢ç·šé™åˆ¶ï¼š** åœ¨è¡Œå‹•è£ç½®é›¢ç·šæ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ OData æŸ¥è©¢æ™‚ï¼ŒæŸäº›æ¬„ä½å‹åˆ¥ (å¦‚å¤šé¸é¸é …é›†ã€æª”æ¡ˆã€åœ–ç‰‡) å’Œéƒ¨åˆ†åŠŸèƒ½ (å¦‚åˆ†çµ„ã€èšåˆ) å¯èƒ½ä¸è¢«æ”¯æ´ã€‚
6. **æ ¸å¿ƒé—œè¯ï¼šè³‡æ–™å‹åˆ¥æ˜¯å…±é€šèªè¨€**
    
    - åœ¨ Custom API ä¸­å®šç¾©çš„åƒæ•¸å‹åˆ¥ï¼Œèˆ‡æ‚¨ä½¿ç”¨ `retrieveMultipleRecords` å–å›çš„è³‡æ–™æ¬„ä½å‹åˆ¥ï¼Œä»¥åŠä½¿ç”¨ `execute` å»ºç«‹/æ›´æ–°ç´€éŒ„æ™‚éœ€è¦æä¾›çš„è³‡æ–™å‹åˆ¥ï¼Œæ˜¯**å®Œå…¨ä¸€è‡´**çš„ã€‚
    - ç†è§£é€™äº›è³‡æ–™å‹åˆ¥ï¼ˆå¦‚ä½•å®šç¾©ã€EDM è¡¨ç¤ºæ³•ã€åœ¨ JavaScript å’Œ Plugin ä¸­å¦‚ä½•è™•ç†ï¼‰æ˜¯èˆ‡ Dynamics è³‡æ–™é€²è¡Œå¯é äº’å‹•çš„**åŸºç¤**ã€‚

**ç¸½çµèˆ‡å»ºè­°ï¼š**

é€™æ®µ Deep Dive å¼·èª¿äº†ç†è§£ Dynamics 365 ä¸­ Custom API åƒæ•¸è³‡æ–™å‹åˆ¥çš„é‡è¦æ€§ï¼Œä¸¦èªªæ˜äº†å¦‚ä½•é€é `Xrm.WebApi.online.execute` å’Œ `Xrm.WebApi.retrieveMultipleRecords` é€™å…©å€‹é—œéµçš„ Web API æ–¹æ³•ä¾†èˆ‡ä¹‹äº’å‹•ã€‚æŒæ¡é€™äº›æ¦‚å¿µæ˜¯å»ºç«‹æ›´è¤‡é›œã€æ›´å¥å£¯çš„ Dynamics 365 æ“´å……åŠŸèƒ½çš„åŸºçŸ³ã€‚å»ºè­°å¯¦éš›å‹•æ‰‹å»ºç«‹ç°¡å–®çš„ Custom API ä¸¦å˜—è©¦å‘¼å«ï¼Œä»¥åŠ æ·±ç†è§£ã€‚
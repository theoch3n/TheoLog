```csharp
            
            /**
             public class CombinedIncidentAutoResolutionPlugin : PluginHandler, IPlugin
{
    // 配置值 (集中管理)
    Private readonly Guid WO_SUBSTATUS_AUTO_CLOSED_GUID = new Guid ("YOUR_GUID");
    Private readonly Guid WO_SUBSTATUS_REVIEW_CLOSED_GUID = new Guid ("YOUR_GUID");
    private readonly List<Guid> ClosedWoSubstatusGuids => new List<Guid> { WO_SUBSTATUS_AUTO_CLOSED_GUID, WO_SUBSTATUS_REVIEW_CLOSED_GUID };
    Private const string CASE_LOOKUP_ON_WO = "msdyn_servicerequest"; // 確認正確欄位
    Private const string CASE_BPF_INSTANCE_ENTITY_NAME = "YOUR_BPF_ENTITY_NAME";
    Private readonly Guid BPF_STAGE_ID_CLOSED = new Guid ("YOUR_GUID");
    Private const int CASE_TYPE_CONSULTING = YOUR_VALUE;

    Protected override string PluginName => "CombinedIncidentAutoResolutionPlugin";
    Public override LogLevel CurrentLogLevel => LogLevel. Debug;
    Protected override string[] RequiredInputParameters => new string[] { "Target" };

    Public void Execute (IServiceProvider serviceProvider) => Run (serviceProvider);

    Protected override void ExecuteCore ()
    {
        Log (LogLevel. Debug, "Starting CombinedIncidentAutoResolutionPlugin");

        // 1. 驗證消息和實體
        If (_context.MessageName.ToLower () != "update" || _context.PrimaryEntityName.ToLower () != "msdyn_workorder")
        {
            Log (LogLevel. Debug, "Not an update on msdyn_workorder, exiting.");
            Return;
        }

        // 2. 檢查遞迴深度
        If (_context. Depth > 1)
        {
            Log (LogLevel. Warning, "Depth > 1, exiting to prevent recursion.");
            Return;
        }

        // 3. 獲取 PostImage
        Entity postImage = GetPostImage ("PostImage");
        If (postImage == null)
        {
            Log (LogLevel. Error, "PostImage not found, exiting.");
            Return;
        }

        // 4. 檢查子狀態
        EntityReference woSubStatusRef = postImage. GetAttributeValue<EntityReference>("msdyn_substatus");
        If (woSubStatusRef == null || !ClosedWoSubstatusGuids.Contains (woSubStatusRef. Id))
        {
            Log (LogLevel. Debug, "Substatus not in closed list, exiting.");
            Return;
        }

        // 5. 獲取父案例
        EntityReference parentCaseRef = postImage. GetAttributeValue<EntityReference>(CASE_LOOKUP_ON_WO);
        If (parentCaseRef == null)
        {
            Log (LogLevel. Info, "No parent case, exiting.");
            Return;
        }

        // 6. 檢查所有工單是否結案
        QueryExpression query = new QueryExpression ("msdyn_workorder")
        {
            ColumnSet = new ColumnSet ("msdyn_substatus"),
            Criteria = { Conditions = { new ConditionExpression (CASE_LOOKUP_ON_WO, ConditionOperator. Equal, parentCaseRef. Id) } }
        };
        EntityCollection relatedWOs = _service.RetrieveMultiple (query);

        Bool allWorkOrdersClosed = relatedWOs.Entities.All (wo =>
        {
            var subStatusRef = wo. GetAttributeValue<EntityReference>("msdyn_substatus");
            Return subStatusRef != null && ClosedWoSubstatusGuids.Contains (subStatusRef. Id);
        });

        If (! AllWorkOrdersClosed)
        {
            Log (LogLevel. Info, "Not all work orders closed, exiting.");
            Return;
        }

        // 7. 檢查案例狀態和類型
        Entity currentCase = _service.Retrieve ("incident", parentCaseRef. Id, new ColumnSet ("statecode", "casetypecode"));
        if (currentCase. GetAttributeValue<OptionSetValue>("statecode")?. Value == 1)
        {
            Log (LogLevel. Info, "Case already resolved, exiting.");
            Return;
        }
        if (currentCase. GetAttributeValue<OptionSetValue>("casetypecode")?. Value == CASE_TYPE_CONSULTING)
        {
            Log (LogLevel. Info, "Case is consulting type, exiting.");
            Return;
        }

        // 8. 關閉案例
        Var closeRequest = new CloseIncidentRequest
        {
            IncidentResolution = new Entity ("incidentresolution")
            {
                ["subject"] = "Auto-closed due to all work orders completed",
                ["incidentid"] = parentCaseRef
            },
            Status = new OptionSetValue (5) // Problem Solved
        };
        _service.Execute (closeRequest);
        Log (LogLevel. Info, "Case closed successfully.");

        // 9. 更新 BPF
        QueryExpression bpfQuery = new QueryExpression (CASE_BPF_INSTANCE_ENTITY_NAME)
        {
            ColumnSet = new ColumnSet ("activityid"),
            Criteria = { Conditions = { new ConditionExpression ("bpf_incidentid", ConditionOperator. Equal, parentCaseRef. Id) } },
            TopCount = 1
        };
        EntityCollection bpfInstances = _service.RetrieveMultiple (bpfQuery);

        If (bpfInstances.Entities.Any ())
        {
            Entity bpfInstanceToUpdate = new Entity (CASE_BPF_INSTANCE_ENTITY_NAME, bpfInstances. Entities[0]. Id)
            {
                ["activestageid"] = new EntityReference ("processstage", BF_STAGE_ID_CLOSED),
                ["statecode"] = new OptionSetValue (1),
                ["statuscode"] = new OptionSetValue (2)
            };
            _service.Update (bpfInstanceToUpdate);
            Log (LogLevel. Info, "BPF updated to closed stage and completed.");
        }
        Else
        {
            Log (LogLevel. Warning, "No active BPF instance found.");
        }
    }
}
             */
```
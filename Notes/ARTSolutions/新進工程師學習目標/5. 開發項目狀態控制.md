#### ğŸ“… **Date**: 2025-04-18
#### ğŸ”– **Tags**: #Plugin #Action #JavaScript #RibbonButton #Dynamics365 #PowerPlatform #WebApi #PluginAssembly #Dataverse

---
## é …ç›®éœ€æ±‚èªªæ˜

æ­¤é–‹ç™¼é …ç›®æ—¨åœ¨é€éè¡¨å–®ä¸Šçš„ Ribbon Button (åŠŸèƒ½å€æŒ‰éˆ•) ä¾†ç®¡ç†ã€Œé–‹ç™¼é …ç›®ã€(Development Task) çš„ç”Ÿå‘½é€±æœŸç‹€æ…‹ï¼ŒåŒ…å«ä»¥ä¸‹æ“ä½œï¼š

-   **äº¤æ´¾ (Assign):** å°‡é …ç›®äº¤æ´¾çµ¦æŒ‡å®šå“¡å·¥ã€‚
-   **é–‹ç™¼å®Œæˆ (DevDone):** å“¡å·¥å®Œæˆå¾Œé»æ“Šï¼Œç™¼èµ·é©—æ”¶é€šçŸ¥ã€‚
-   **é€šé (Approve):** é©—æ”¶æˆåŠŸï¼Œé …ç›®çµæ¡ˆã€‚
-   **é€€å› (Reject):** é©—æ”¶å¤±æ•—ï¼Œé€€å›çµ¦å“¡å·¥ã€‚

---

## å…ƒä»¶è¨­è¨ˆæ¦‚è§€

ç‚ºå¯¦ç¾æ­¤åŠŸèƒ½ï¼Œè¨­è¨ˆäº†ä»¥ä¸‹å…ƒä»¶ï¼š

### 1. è³‡æ–™è¡¨èˆ‡ Ribbon æŒ‰éˆ•è¨­å®š (Table: DevelopmentTask)

åœ¨ `DevelopmentTask` è¡¨å–®ä¸Šè¨­å®šä»¥ä¸‹æŒ‰éˆ•ï¼š

| æŒ‰éˆ•å…§éƒ¨åç¨± (ID) | é¡¯ç¤ºåç¨±   | JavaScript Action Function | JavaScript Enable Function |
| :---------------- | :--------- | :------------------------- | :------------------------- |
| `BTN_Assign`      | äº¤æ´¾       | `Assign_action`            | `Assign_enable`            |
| `BTN_DevDone`     | é–‹ç™¼å®Œæˆ   | `DevDone_action`           | `DevDone_enable`           |
| `BTN_Approve`     | é€šé       | `Approve_action`           | `Approve_enable`           |
| `BTN_Reject`      | é€€å›       | `Reject_action`            | `Reject_enable`            |

### 2. å‰ç«¯ JavaScript é‚è¼¯ (WebResource: DevelopmentTaskLibrary)

å»ºç«‹ `DevelopmentTaskLibrary.js`ï¼ŒåŒ…å«è™•ç†ä¸Šè¿°æŒ‰éˆ•çš„ `_enable` (å•Ÿç”¨é‚è¼¯) å’Œ `_action` (é»æ“Šäº‹ä»¶) å‡½æ•¸ã€‚`_action` å‡½æ•¸è² è²¬å‘¼å«å¾Œç«¯ Custom Actionã€‚

### 3. å¾Œç«¯è‡ªè¨‚æµç¨‹ (Custom Actions)

-   **`theo_SetDevelopmentTaskStatus`**
    * **Input:** `Operation` (string): "Assign", "DevDone", "Approve", "Reject"ã€‚
    * **Input:** `Target` (EntityReference: DevelopmentTask): æŒ‡å‘ç›®æ¨™é–‹ç™¼é …ç›®ã€‚
-   **`theo_SetRejectSetting`**
    * **Input:** `Target` (EntityReference: DevelopmentTask): æŒ‡å‘è¢«é€€å›çš„é–‹ç™¼é …ç›®ã€‚

### 4. å¾Œç«¯ä¸»è¦é‚è¼¯ (PluginAssembly: DevelopmentTaskLogic)

å»ºç«‹ `DevelopmentTaskLogic.dll`ï¼ŒåŒ…å«è™•ç† Action çš„ Pluginï¼š

-   **`SetDevelopmentTaskStatusPlugin`**
    * **Step:** è¨»å†Šåœ¨ `theo_SetDevelopmentTaskStatus` Action (PostOperation, Sync)ã€‚
    * **é‚è¼¯:** ä¾ `Operation` æ›´æ–°ç‹€æ…‹/æ™‚é–“ï¼›è‹¥ç‚º "Reject"ï¼Œå‰‡å‘¼å« `theo_SetRejectSetting` Actionã€‚
-   **`SetRejectSettingPlugin`**
    * **Step:** è¨»å†Šåœ¨ `theo_SetRejectSetting` Action (PostOperation, Sync)ã€‚
    * **é‚è¼¯:** æ¸…ç©ºäº¤ä»˜æ™‚é–“ã€å¢åŠ é€€å›æ¬¡æ•¸ã€å¢åŠ è² è²¬äººé€€ä»¶æ•¸ã€‚

---
## è©³ç´°å¯¦ä½œé‚è¼¯èªªæ˜

### 1. JavaScript (DevelopmentTaskLibrary) è©³è§£

æ­¤ Web Resource æ§åˆ¶æŒ‰éˆ•çš„é¡¯ç¤ºèˆ‡è¡Œç‚ºã€‚

```javascript
/** Choices Value
 * éœ€æ±‚ç¢ºèª value: 638540000
 * é–‹ç™¼ä¸­ value: 638540001
 * å¾…å¯©æ ¸ value: 638540002
 * çµæ¡ˆ value: 638540003
 */
// #region Assign
async function Assign_action(formContext) {
    // åŸ·è¡ŒAction: SetDevelopmentTaskStatus
    // å‚³å…¥åƒæ•¸: Operation = "Assign"
    // æˆåŠŸåŸ·è¡ŒActionå¾Œé‡æ–°æ•´ç†é é¢
    console.log("Assign_action called");
    const taskOwnerAttr = formContext.getAttribute("theo_taskowner");
    const taskOwnerValue = taskOwnerAttr.getValue();
    console.log(`äº¤æ´¾çµ¦: ${taskOwnerValue}`);
    if (!taskOwnerValue) {
        console.error("è«‹å…ˆé¸æ“‡è² è²¬äºº");
        return;
    }
    await callSetStatusAction(formContext, "Assign");
    console.log("Assign_action ended");
}
function Assign_enable(formContext) {
    // TaskStatusç‚º"éœ€æ±‚ç¢ºèª"æ™‚æ‰é¡¯ç¤º, å…¶ä»–ç‹€æ…‹çš†ä¸é¡¯ç¤º
    console.log("Assign enable called");

    /**
     * formContext.ui.getFormType() é€™å€‹æ–¹æ³•å¯ä»¥å–å¾—ç›®å‰è¡¨å–®çš„æ¨¡å¼ï¼š
     * 1: Create (å»ºç«‹/æ–°å¢)
     * 2: Update (æ›´æ–°/ç·¨è¼¯å·²å„²å­˜çš„ç´€éŒ„)
     * 3: Read Only (å”¯è®€)
     * 4: Disabled (åœç”¨)
     * 6: Bulk Edit (å¤§é‡ç·¨è¼¯)
     */
    const formType = formContext.ui.getFormType(); // å–å¾—è¡¨å–®é¡å‹ï¼Œç¢ºä¿äº¤æ´¾æŒ‰éˆ•åªåœ¨é–‹ç™¼é …ç›®å·²å»ºç«‹æ™‚å¯è¦‹
    console.log(`FormType: ${formType}`);
    const requirementValue = 638540000; // éœ€æ±‚ç¢ºèª
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr.getValue();
    const isEnable = formType === 2 && taskStatusValue === requirementValue;
    console.log(`Assign_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, requirementValue: ${requirementValue})`);

    return isEnable;
}
// #endregion
// #region DevDone
async function DevDone_action(formContext) {
    // åŸ·è¡ŒAction: SetDevelopmentTaskStatus
    // å‚³å…¥åƒæ•¸: Operation = "DevDone"
    // æˆåŠŸåŸ·è¡ŒActionå¾Œé‡æ–°æ•´ç†é é¢
    console.log("DevDone_action called");
    await callSetStatusAction(formContext, "DevDone");
    console.log("DevDone_action ended");
}
function DevDone_enable(formContext) {
    // TaskStatusç‚º"é–‹ç™¼ä¸­"æ™‚æ‰é¡¯ç¤º, å…¶ä»–ç‹€æ…‹çš†ä¸é¡¯ç¤º
    console.log("DevDone enable called");

    const developmentValue = 638540001; // é–‹ç™¼ä¸­
    const formType = formContext.ui.getFormType();
    console.log(`FormType: ${formType}`);
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr.getValue();
    const isEnable = formType === 2 && taskStatusValue === developmentValue;
    console.log(`DevDone_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, developmentValue: ${developmentValue})`);

    return isEnable;
}
// #endregion
// #region Approve
async function Approve_action(formContext) {
    // åŸ·è¡ŒAction: SetDevelopmentTaskStatus
    // å‚³å…¥åƒæ•¸: Operation = "Approve"
    // æˆåŠŸåŸ·è¡ŒActionå¾Œé‡æ–°æ•´ç†é é¢
    console.log("Approve_action called");
    await callSetStatusAction(formContext, "Approve");
    console.log("Approve_action ended");
}
function Approve_enable(formContext) {
    // TaskStatusç‚º"å¾…å¯©æ ¸"æ™‚æ‰é¡¯ç¤º, å…¶ä»–ç‹€æ…‹çš†ä¸é¡¯ç¤º
    console.log("Approve enable called");

    const pendingValue = 638540002; // å¾…å¯©æ ¸
    const formType = formContext.ui.getFormType();
    console.log(`FormType: ${formType}`);
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr.getValue();
    const isEnable = formType === 2 && taskStatusValue === pendingValue;
    console.log(`Approve_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, pendingValue: ${pendingValue})`);

    return isEnable;
}
// #endregion
// #region Reject
async function Reject_action(formContext) {
    // åŸ·è¡ŒAction: SetDevelopmentTaskStatus
    // å‚³å…¥åƒæ•¸: Operation = "Reject"
    // æˆåŠŸåŸ·è¡ŒActionå¾Œé‡æ–°æ•´ç†é é¢
    console.log("Reject_action called");
    await callSetStatusAction(formContext, "Reject");
    console.log("Reject_action ended");
}
function Reject_enable(formContext) {
    // TaskStatusç‚º"å¾…å¯©æ ¸"æ™‚æ‰é¡¯ç¤º, å…¶ä»–ç‹€æ…‹çš†ä¸é¡¯ç¤º
    console.log("Reject enable called");

    const pendingValue = 638540002; // å¾…å¯©æ ¸
    const formType = formContext.ui.getFormType();
    console.log(`FormType: ${formType}`);
    const taskStatusAttr = formContext.getAttribute("theo_taskstatus");
    const taskStatusValue = taskStatusAttr.getValue();
    const isEnable = formType === 2 && taskStatusValue === pendingValue;
    console.log(`Reject_enable: ${isEnable} (taskStatusValue: ${taskStatusValue}, pendingValue: ${pendingValue})`);

    return isEnable;
}
// #endregion
// #region Call Action SetDevelopmentTaskStatus
async function callSetStatusAction(formContext, operation) {
    console.log("åŸ·è¡Œ callSetStatusAction");

    const recordId = formContext.data.entity.getId().replace(/[{}]/g, "");
    console.log("recordId:", recordId);
    const entityName = formContext.data.entity.getEntityName();

    const actionName = "theo_SetDevelopmentTaskStatus";

    const request = {
        Operation: operation,
        Target: {
            "@odata.type": `Microsoft.Dynamics.CRM.${entityName}`,
            [`${entityName}id`]: recordId,
        },
        getMetadata: () => ({
            parameterTypes: {
                Target: {
                    typeName: `mscrm.${entityName}`,
                    structuralProperty: 5, // EntityReference
                },
                Operation: {
                    typeName: "Edm.String",
                    structuralProperty: 1, // åŸºç¤å‹åˆ¥
                },
            },
            operationType: 0, // Action
            operationName: actionName,
        }),
    };

    console.log("request:", request);

    const response = await Xrm.WebApi.online.execute(request);
    if (response.ok) {
        console.log(`Action '${actionName}' åŸ·è¡ŒæˆåŠŸ, Status code: ${response.status}`);
        formContext.data.refresh(true); // é‡æ–°æ•´ç†é é¢
        console.log("é é¢å·²é‡æ–°æ•´ç†");
    } else {
        const error = await response.json();
        console.log(`Action '${actionName}' åŸ·è¡Œå¤±æ•—, Status code: ${response.status}`, error);
    }
}
// #endregion
```

**JavaScript ä¸»è¦é‚è¼¯ï¼š**

- **`_enable` å‡½æ•¸ï¼š** æª¢æŸ¥è¡¨å–®ç‹€æ…‹ (`formContext.ui.getFormType() === 2` ç¢ºä¿è¨˜éŒ„å·²å„²å­˜) å’Œä»»å‹™ç‹€æ…‹ (`theo_taskstatus`) ä¾†æ±ºå®šæŒ‰éˆ•æ˜¯å¦å¯ç”¨ã€‚
- **`Assign_action` å‡½æ•¸ï¼š** åœ¨å‘¼å«å¾Œç«¯å‰ï¼Œå¢åŠ å‰ç«¯é©—è­‰ï¼Œç¢ºä¿ã€Œé …ç›®è² è²¬äººã€(`theo_taskowner`) æ¬„ä½å·²è¢«å¡«å¯«ã€‚
- **`callSetStatusAction` (å…±ç”¨å‡½æ•¸)ï¼š**
    - è™•ç†æ‰€æœ‰æŒ‰éˆ•å‘¼å«å¾Œç«¯ `theo_SetDevelopmentTaskStatus` Action çš„é‚è¼¯ã€‚
    - æª¢æŸ¥è¨˜éŒ„æ˜¯å¦å·²å„²å­˜ (`recordId` æ˜¯å¦å­˜åœ¨)ã€‚
    - æ­£ç¢ºæ§‹å»º `Xrm.WebApi.online.execute` æ‰€éœ€çš„ `request` ç‰©ä»¶ (åŒ…å« `Operation` å’Œ `Target` åƒæ•¸)ã€‚
    - ä½¿ç”¨ `async/await` è™•ç†éåŒæ­¥æ“ä½œã€‚
    - æˆåŠŸå¾Œä½¿ç”¨ `formContext.data.refresh(true)` åˆ·æ–°é é¢ã€‚
### 2. Plugin (SetDevelopmentTaskStatusPlugin) è©³è§£

è™•ç† `theo_SetDevelopmentTaskStatus` Action çš„å¾Œç«¯é‚è¼¯ã€‚

```csharp
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Runtime.Remoting.Contexts;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Query;

namespace DevelopmentTaskLogic {
    public class SetDevelopmentTaskStatusPlugin : IPlugin {
        public void Execute(IServiceProvider serviceProvider) {
            #region 1. å–å¾—åŸ·è¡Œç’°å¢ƒèˆ‡æœå‹™
Â  Â  Â  Â  Â  Â  // å¾ serviceProvider å–å¾—æ’ä»¶åŸ·è¡Œä¸Šä¸‹æ–‡ (IPluginExecutionContext)
Â  Â  Â  Â  Â  Â  // context åŒ…å«è§¸ç™¼äº‹ä»¶çš„è©³ç´°è³‡è¨Šï¼Œä¾‹å¦‚æ¶‰åŠçš„å¯¦é«”ã€æ“ä½œé¡å‹å’Œè§¸ç™¼çš„ä½¿ç”¨è€…
Â  Â  Â  Â  Â  Â  IPluginExecutionContext context = (IPluginExecutionContext)serviceProvider.GetService(typeof(IPluginExecutionContext));

Â  Â  Â  Â  Â  Â  // å¾ serviceProvider å–å¾—çµ„ç¹”æœå‹™å·¥å»  (IOrganizationServiceFactory)
Â  Â  Â  Â  Â  Â  // ç”¨æ–¼å»ºç«‹èˆ‡ Dynamics 365/Dataverse äº’å‹•çš„çµ„ç¹”æœå‹™ç‰©ä»¶
Â  Â  Â  Â  Â  Â  IOrganizationServiceFactory serviceFactory = (IOrganizationServiceFactory)serviceProvider.GetService(typeof(IOrganizationServiceFactory));

Â  Â  Â  Â  Â  Â  // ä½¿ç”¨å·¥å» å»ºç«‹çµ„ç¹”æœå‹™ (IOrganizationService) å¯¦ä¾‹
Â  Â  Â  Â  Â  Â  // ä»¥è§¸ç™¼äº‹ä»¶çš„ä½¿ç”¨è€…æ¬Šé™ (context.UserId) åŸ·è¡Œæ“ä½œ
Â  Â  Â  Â  Â  Â  IOrganizationService service = serviceFactory.CreateOrganizationService(context.UserId);

Â  Â  Â  Â  Â  Â  // å¾ serviceProvider å–å¾—è¿½è¹¤æœå‹™ (ITracingService)
Â  Â  Â  Â  Â  Â  // ç”¨æ–¼è¨˜éŒ„æ’ä»¶åŸ·è¡Œéç¨‹ä¸­çš„è¨Šæ¯ï¼Œæ–¹ä¾¿é™¤éŒ¯
Â  Â  Â  Â  Â  Â  ITracingService tracer = (ITracingService)serviceProvider.GetService(typeof(ITracingService));
Â  Â  Â  Â  Â  Â  #endregion

Â  Â  Â  Â  Â  Â  #region 2. æ¥­å‹™é‚è¼¯
Â  Â  Â  Â  Â  Â  /** SetDevelopmentTaskStatus
              * ç•¶ Operation å€¼ç‚ºâ€Assignâ€æ™‚, å°‡Targetçš„é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œé–‹ç™¼ä¸­ã€, ä¸¦è¨˜éŒ„ã€Œäº¤æ´¾æ™‚é–“ã€
              * ç•¶ Operation å€¼ç‚ºâ€DevDoneâ€æ™‚, å°‡Targetçš„é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œå¾…å¯©æ ¸ã€, ä¸¦è¨˜éŒ„ã€Œäº¤ä»˜æ™‚é–“ã€
              * ç•¶ Operation å€¼ç‚ºâ€Approveâ€æ™‚, å°‡Targetçš„é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œçµæ¡ˆã€, ä¸¦è¨˜éŒ„ã€Œçµæ¡ˆæ™‚é–“ã€
              * ç•¶ Operation å€¼ç‚ºâ€Rejectâ€æ™‚, å‘¼å«é€€å›é …ç›®Action
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  tracer.Trace("åŸ·è¡Œ SetDevelopmentTaskStatusPlugin");

            // Task Status Value
            /** Choices Value
              * éœ€æ±‚ç¢ºèª value: 638540000
              * é–‹ç™¼ä¸­ value: 638540001
              * å¾…å¯©æ ¸ value: 638540002
              * çµæ¡ˆ value: 638540003
              */
            const int developmentValue = 638540001; // é–‹ç™¼ä¸­
            const int pendingValue = 638540002; // å¾…å¯©æ ¸
            const int closedValue = 638540003; // çµæ¡ˆ

            // æ¬„ä½çš„ LogicalName
            const string statusField = "theo_taskstatus";
            const string assignTimeField = "theo_assigntime";
            const string deliverTimeField = "theo_delivertime";
            const string closeTimeField = "theo_closetime";

            // é€€å›é …ç›® Action åç¨±
            const string rejectActionName = "theo_SetRejectSetting";

            try {
                string operation = (string)context.InputParameters["Operation"];
                tracer.Trace($"æ”¶åˆ°çš„ Operation: {operation}");
                EntityReference targetRef = (EntityReference)context.InputParameters["Target"];
                tracer.Trace($"æ”¶åˆ°çš„ Target: Entity={targetRef.LogicalName}, ID={targetRef.Id}");

                Entity taskToUpdate = new Entity(targetRef.LogicalName, targetRef.Id);
                DateTime currentTime = DateTime.UtcNow;

                switch (operation) {
                    case "Assign":
                        tracer.Trace("åŸ·è¡Œ Assign æ“ä½œ");
                        taskToUpdate[statusField] = new OptionSetValue(developmentValue);
                        taskToUpdate[assignTimeField] = currentTime;
                        service.Update(taskToUpdate);
                        tracer.Trace("é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œé–‹ç™¼ä¸­ã€, ä¸¦è¨˜éŒ„ã€Œäº¤æ´¾æ™‚é–“ã€");
                        break;
                    case "DevDone":
                        tracer.Trace("åŸ·è¡Œ DevDone æ“ä½œ");
                        taskToUpdate[statusField] = new OptionSetValue(pendingValue);
                        taskToUpdate[deliverTimeField] = currentTime;
                        service.Update(taskToUpdate);
                        tracer.Trace("é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œå¾…å¯©æ ¸ã€, ä¸¦è¨˜éŒ„ã€Œäº¤ä»˜æ™‚é–“ã€");
                        break;
                    case "Approve":
                        tracer.Trace("åŸ·è¡Œ Approve æ“ä½œ");
                        taskToUpdate[statusField] = new OptionSetValue(closedValue);
                        taskToUpdate[closeTimeField] = currentTime;
                        service.Update(taskToUpdate);
                        tracer.Trace("é …ç›®ç‹€æ…‹æ›´æ–°ç‚ºã€Œçµæ¡ˆã€, ä¸¦è¨˜éŒ„ã€Œçµæ¡ˆæ™‚é–“ã€");
                        break;
                    case "Reject":
                        tracer.Trace("åŸ·è¡Œ Reject æ“ä½œ");
                        OrganizationRequest rejectRequest = new OrganizationRequest(rejectActionName);
                        rejectRequest["Target"] = targetRef;
                        service.Execute(rejectRequest);
                        tracer.Trace($"åŸ·è¡Œ Action: {rejectActionName}");
                        break;
                    default:
                        tracer.Trace($"æœªçŸ¥çš„æ“ä½œ: {operation}");
                        break;
                }
                tracer.Trace("SetDevelopmentTaskStatusPlugin åŸ·è¡Œå®Œç•¢");
            } catch (Exception ex) {
                tracer.Trace($"SetDevelopmentTaskStatusPlugin Error: {ex.ToString()}");
            }
            #endregion
        }
    }
}

```

**Plugin ä¸»è¦é‚è¼¯ï¼š**

- æ¥æ”¶ `Operation` å’Œ `Target` è¼¸å…¥åƒæ•¸ã€‚
- ä½¿ç”¨ `switch` èªå¥æ ¹æ“š `Operation` çš„å€¼åŸ·è¡Œä¸åŒæ“ä½œï¼š
    - **Assign, DevDone, Approve:** å»ºç«‹ä¸€å€‹ `Entity` ç‰©ä»¶ (`taskToUpdate`)ï¼Œè¨­å®šè¦æ›´æ–°çš„ç‹€æ…‹ (`OptionSetValue`) å’Œå°æ‡‰çš„æ™‚é–“æˆ³ (`DateTime.UtcNow`)ï¼Œç„¶å¾Œå‘¼å« `service.Update()`ã€‚
    - **Reject:** å»ºç«‹ä¸€å€‹ `OrganizationRequest` ç‰©ä»¶ï¼ŒæŒ‡å®šè¦å‘¼å«çš„ Action åç¨± (`theo_SetRejectSetting`)ï¼Œå°‡ `Target` ä½œç‚ºåƒæ•¸å‚³éï¼Œä¸¦å‘¼å« `service.Execute()` ä¾†è§¸ç™¼å¦ä¸€å€‹ Plugin (`SetRejectSettingPlugin`) åŸ·è¡Œå¾ŒçºŒçš„é€€å›é‚è¼¯ã€‚

### 3. Plugin (SetRejectSettingPlugin) è©³è§£

è™•ç† `theo_SetRejectSetting` Actionï¼Œè² è²¬é€€å›æ“ä½œçš„è³‡æ–™æ›´æ–°ã€‚

```csharp
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Runtime.Remoting.Contexts;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Xrm.Sdk;
using Microsoft.Xrm.Sdk.Query;

namespace DevelopmentTaskLogic {
    public class SetRejectSettingPlugin : IPlugin {
        public void Execute(IServiceProvider serviceProvider) {
            #region 1. å–å¾—åŸ·è¡Œç’°å¢ƒèˆ‡æœå‹™
Â  Â  Â  Â  Â  Â  // å¾ serviceProvider å–å¾—æ’ä»¶åŸ·è¡Œä¸Šä¸‹æ–‡ (IPluginExecutionContext)
Â  Â  Â  Â  Â  Â  // context åŒ…å«è§¸ç™¼äº‹ä»¶çš„è©³ç´°è³‡è¨Šï¼Œä¾‹å¦‚æ¶‰åŠçš„å¯¦é«”ã€æ“ä½œé¡å‹å’Œè§¸ç™¼çš„ä½¿ç”¨è€…
Â  Â  Â  Â  Â  Â  IPluginExecutionContext context = (IPluginExecutionContext)serviceProvider.GetService(typeof(IPluginExecutionContext));

Â  Â  Â  Â  Â  Â  // å¾ serviceProvider å–å¾—çµ„ç¹”æœå‹™å·¥å»  (IOrganizationServiceFactory)
Â  Â  Â  Â  Â  Â  // ç”¨æ–¼å»ºç«‹èˆ‡ Dynamics 365/Dataverse äº’å‹•çš„çµ„ç¹”æœå‹™ç‰©ä»¶
Â  Â  Â  Â  Â  Â  IOrganizationServiceFactory serviceFactory = (IOrganizationServiceFactory)serviceProvider.GetService(typeof(IOrganizationServiceFactory));

Â  Â  Â  Â  Â  Â  // ä½¿ç”¨å·¥å» å»ºç«‹çµ„ç¹”æœå‹™ (IOrganizationService) å¯¦ä¾‹
Â  Â  Â  Â  Â  Â  // ä»¥è§¸ç™¼äº‹ä»¶çš„ä½¿ç”¨è€…æ¬Šé™ (context.UserId) åŸ·è¡Œæ“ä½œ
Â  Â  Â  Â  Â  Â  IOrganizationService service = serviceFactory.CreateOrganizationService(context.UserId);

Â  Â  Â  Â  Â  Â  // å¾ serviceProvider å–å¾—è¿½è¹¤æœå‹™ (ITracingService)
Â  Â  Â  Â  Â  Â  // ç”¨æ–¼è¨˜éŒ„æ’ä»¶åŸ·è¡Œéç¨‹ä¸­çš„è¨Šæ¯ï¼Œæ–¹ä¾¿é™¤éŒ¯
Â  Â  Â  Â  Â  Â  ITracingService tracer = (ITracingService)serviceProvider.GetService(typeof(ITracingService));
Â  Â  Â  Â  Â  Â  #endregion

Â  Â  Â  Â  Â  Â  #region 2. æ¥­å‹™é‚è¼¯
Â  Â  Â  Â  Â  Â  /** SetRejectSetting
              * æ¸…ç©ºTargetçš„ã€Œäº¤ä»˜æ™‚é–“ã€
              * è¨­å®šTargetçš„ã€Œé€€ä»¶æ¬¡æ•¸ã€+1
              * è¨­å®šTargetå°æ‡‰çš„ã€Œé …ç›®è² è²¬äººã€çš„ã€Œé–‹ç™¼é …ç›®é€€ä»¶æ•¸ã€+1
Â  Â  Â  Â  Â  Â  Â */

Â  Â  Â  Â  Â  Â  tracer.Trace("åŸ·è¡Œ SetRejectSettingPlugin");
            // æ¬„ä½çš„ LogicalName
            // DevelopmentTask
            const string deliverTimeField = "theo_delivertime";
            const string rejectCountField = "theo_rejectcount";
            const string taskOwnerField = "theo_taskowner";
            // Employee
            const string employeeTaskRejectCountField = "theo_taskrejectcount";

            try {
                EntityReference targetRef = (EntityReference)context.InputParameters["Target"];
                tracer.Trace($"æ”¶åˆ°çš„ Target: Entity={targetRef.LogicalName}, ID={targetRef.Id}");
                Entity retrievedTask = service.Retrieve(targetRef.LogicalName, targetRef.Id,
                    new ColumnSet(rejectCountField, taskOwnerField));
                Entity taskToUpdate = new Entity(targetRef.LogicalName, targetRef.Id);

                taskToUpdate[deliverTimeField] = null; // æ¸…ç©ºäº¤ä»˜æ™‚é–“
                int currentRejectCount = retrievedTask.GetAttributeValue<int?>(rejectCountField).GetValueOrDefault();
                taskToUpdate[rejectCountField] = currentRejectCount + 1; // é€€ä»¶æ¬¡æ•¸ + 1
                service.Update(taskToUpdate); // æ›´æ–° DevelopmentTask
                tracer.Trace($"æ¸…ç©º {targetRef.LogicalName} çš„ã€Œäº¤ä»˜æ™‚é–“ã€, ã€Œé€€ä»¶æ¬¡æ•¸ã€å¾ {currentRejectCount} æ›´æ–°ç‚º {currentRejectCount + 1}");

                EntityReference employeeRef = retrievedTask.GetAttributeValue<EntityReference>(taskOwnerField);
                tracer.Trace($"é …ç›®è² è²¬äººID: {employeeRef.Id}");
                Entity retrievedEmployee = service.Retrieve(employeeRef.LogicalName, employeeRef.Id,
                    new ColumnSet(employeeTaskRejectCountField));
                Entity employeeToUpdate = new Entity(employeeRef.LogicalName, employeeRef.Id);
                int currentEmployeeRejectCount = retrievedEmployee.GetAttributeValue<int?>(employeeTaskRejectCountField).GetValueOrDefault();

                employeeToUpdate[employeeTaskRejectCountField] = currentEmployeeRejectCount + 1; // é–‹ç™¼é …ç›®é€€ä»¶æ•¸ + 1
                service.Update(employeeToUpdate); // æ›´æ–° Employee
                tracer.Trace($"æ›´æ–° {employeeRef.LogicalName} çš„ã€Œé–‹ç™¼é …ç›®é€€ä»¶æ•¸ã€å¾ {currentEmployeeRejectCount} æ›´æ–°ç‚º {currentEmployeeRejectCount + 1}");
                tracer.Trace("SetRejectSettingPlugin åŸ·è¡Œå®Œç•¢");
            } catch (Exception ex) {
                tracer.Trace($"SetRejectSettingPlugin Error: {ex.ToString()}");
            }
Â  Â  Â  Â  Â  Â  #endregion
        }
    }
}

```

**`SetRejectSettingPlugin` ä¸»è¦é‚è¼¯èˆ‡æ”¹é€²ï¼š**

- ç²å–å‚³å…¥çš„ `Target` (Development Task çš„åƒç…§)ã€‚
- æŸ¥è©¢è©² Development Task çš„ç›®å‰é€€ä»¶æ¬¡æ•¸å’Œè² è²¬äººã€‚
- æ›´æ–° Development Taskï¼šå°‡äº¤ä»˜æ™‚é–“è¨­ç‚º `null`ï¼Œä¸¦å°‡é€€ä»¶æ¬¡æ•¸åŠ  1ã€‚
- å¦‚æœè² è²¬äººå­˜åœ¨ï¼ŒæŸ¥è©¢è©²è² è²¬äººï¼ˆå“¡å·¥ï¼‰çš„ç›®å‰ã€Œé–‹ç™¼é …ç›®é€€ä»¶æ•¸ã€ã€‚
- æ›´æ–°å“¡å·¥è¨˜éŒ„ï¼Œå°‡å…¶ã€Œé–‹ç™¼é …ç›®é€€ä»¶æ•¸ã€åŠ  1ã€‚

---

## ç›¸é—œæ ¸å¿ƒæ¦‚å¿µï¼šCustom API èˆ‡è³‡æ–™å‹åˆ¥

(æ­¤éƒ¨åˆ†ç‚ºç†è§£æœ¬å¯¦ä½œçš„èƒŒæ™¯çŸ¥è­˜)

- **Custom API (è‡ªè¨‚ API):** å°è£æ¥­å‹™é‚è¼¯ä¾›é‡è¤‡å‘¼å«ï¼Œå…·æ˜ç¢ºè¼¸å…¥/è¼¸å‡ºåƒæ•¸åŠå‹åˆ¥ã€‚
- **è³‡æ–™å‹åˆ¥:** éœ€ç†è§£åŸºç¤å‹åˆ¥ (`String`, `Int`, `DateTime`...) åŠ Dynamics ç‰¹å®šå‹åˆ¥ (`Entity`, `EntityReference`, `OptionSetValue`...) åœ¨ JavaScript (EDM) å’Œ C# ä¸­çš„å°æ‡‰èˆ‡è™•ç†ã€‚
- **`Xrm.WebApi.online.execute`:** å‰ç«¯å‘¼å« Action/Function çš„æ ¸å¿ƒæ–¹æ³•ï¼Œéœ€æ§‹å»ºåŒ…å«åƒæ•¸å’Œ `getMetadata` çš„ `request`ã€‚
- **Plugin åƒæ•¸:** `context.InputParameters` / `context.OutputParameters` å­˜å–åƒæ•¸ï¼Œéœ€é€²è¡Œå‹åˆ¥è½‰æ›ã€‚
- **`Xrm.WebApi.retrieveMultipleRecords`:** å‰ç«¯æŸ¥è©¢å¤šç­†è¨˜éŒ„ï¼Œä½¿ç”¨ OData æˆ– FetchXMLï¼Œéœ€è™•ç†åˆ†é ã€‚

---

## å¯¦ä½œæµç¨‹ç¸½çµ

1. **ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•** -> è§¸ç™¼ **JS `_enable`** æª¢æŸ¥ -> è‹¥å•Ÿç”¨ï¼Œè§¸ç™¼ **JS `_action`**ã€‚
2. `_action` åŸ·è¡Œå‰ç«¯é©—è­‰ (å¦‚æª¢æŸ¥è² è²¬äºº)ã€‚
3. `_action` å‘¼å«å…±ç”¨ **JS `callSetStatusAction`** (å‚³å…¥æ“ä½œé¡å‹)ã€‚
4. `callSetStatusAction` é¡¯ç¤ºé€²åº¦æç¤ºï¼Œæ§‹å»º `request`ï¼Œå‘¼å« **`Xrm.WebApi.online.execute`** è§¸ç™¼å¾Œç«¯ **`theo_SetDevelopmentTaskStatus` Action**ã€‚
5. å¹³å°è§¸ç™¼ **`SetDevelopmentTaskStatusPlugin`**ã€‚
6. Plugin æ ¹æ“š `Operation`ï¼š
    - **Assign/DevDone/Approve:** å‘¼å« `service.Update()` æ›´æ–°ç‹€æ…‹/æ™‚é–“ã€‚
    - **Reject:** å‘¼å« `service.Execute()` è§¸ç™¼ **`theo_SetRejectSetting` Action**ã€‚
7. (è‹¥ç‚º Reject) å¹³å°è§¸ç™¼ **`SetRejectSettingPlugin`**ã€‚
8. `SetRejectSettingPlugin` åŸ·è¡Œæ¸…ç©ºæ™‚é–“ã€å¢åŠ è¨ˆæ•¸ç­‰æ›´æ–°æ“ä½œ (`service.Update`)ã€‚
9. Plugin æˆåŠŸåŸ·è¡Œæˆ–æ‹‹å‡ºéŒ¯èª¤ã€‚
10. **`Xrm.WebApi.online.execute`** è¿”å›æˆåŠŸæˆ–å¤±æ•—å›æ‡‰ã€‚
11. `callSetStatusAction` æ ¹æ“šå›æ‡‰ï¼šåˆ·æ–°é é¢ (æˆåŠŸ) æˆ–é¡¯ç¤ºéŒ¯èª¤å½ˆçª— (å¤±æ•—)ã€‚
12. é—œé–‰é€²åº¦æç¤ºã€‚